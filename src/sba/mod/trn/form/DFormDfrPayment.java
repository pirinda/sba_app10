/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * DFormDfrPayment.java
 *
 * Created on 29/08/2011, 08:02:13 PM
 */

package sba.mod.trn.form;

import cfd.DCfdConsts;
import cfd.DElement;
import cfd.ver33.DElementComprobante;
import cfd.ver33.crp10.DElementDoctoRelacionado;
import cfd.ver33.crp10.DElementPagos;
import cfd.ver33.crp10.DElementPagosPago;
import cfd.ver4.DCfdVer4Consts;
import cfd.ver40.DCfdi40Catalogs;
import java.awt.BorderLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Vector;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JOptionPane;
import javax.swing.ListSelectionModel;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import sba.gui.DGuiClientApp;
import sba.gui.DGuiClientSessionCustom;
import sba.gui.cat.DXmlCatalog;
import sba.gui.util.DUtilConsts;
import sba.lib.DLibConsts;
import sba.lib.DLibTimeUtils;
import sba.lib.DLibUtils;
import sba.lib.db.DDbRegistry;
import sba.lib.grid.DGridColumnForm;
import sba.lib.grid.DGridConsts;
import sba.lib.grid.DGridPaneForm;
import sba.lib.grid.DGridRow;
import sba.lib.grid.DGridUtils;
import sba.lib.gui.DGuiClient;
import sba.lib.gui.DGuiConsts;
import sba.lib.gui.DGuiField;
import sba.lib.gui.DGuiParams;
import sba.lib.gui.DGuiUtils;
import sba.lib.gui.DGuiValidation;
import sba.lib.gui.bean.DBeanFieldDecimal;
import sba.lib.gui.bean.DBeanFieldKey;
import sba.lib.gui.bean.DBeanFieldText;
import sba.lib.gui.bean.DBeanForm;
import sba.mod.DModConsts;
import sba.mod.DModSysConsts;
import sba.mod.bpr.db.DDbBizPartner;
import sba.mod.bpr.db.DDbBizPartnerConfig;
import sba.mod.bpr.db.DDbBranch;
import sba.mod.bpr.db.DDbBranchAddress;
import sba.mod.cfg.db.DDbBranchCash;
import sba.mod.cfg.db.DDbConfigBranch;
import sba.mod.cfg.db.DDbConfigCompany;
import sba.mod.cfg.db.DDbLock;
import sba.mod.cfg.db.DLockUtils;
import sba.mod.trn.db.DDbDfr;
import sba.mod.trn.db.DDbDps;
import sba.mod.trn.db.DDfr;
import sba.mod.trn.db.DDfrCfdRelations;
import sba.mod.trn.db.DRowDfrPayment;
import sba.mod.trn.db.DRowDfrPaymentDoc;
import sba.mod.trn.db.DTrnAmount;
import sba.mod.trn.db.DTrnUtils;

/**
 *
 * @author Sergio Flores
 */
public class DFormDfrPayment extends DBeanForm implements ActionListener, FocusListener, ItemListener, ListSelectionListener {
    
    private final static int MODE_ADD = 1;
    private final static int MODE_MODIFY = 2;

    private DDbDfr moRegistry;
    private DDbLock moRegistryLock;
    private DDbBizPartner moBizPartner;
    private DDbBizPartnerConfig moBizPartnerConfig;
    private DDbBranch moBizPartnerBranchHeadquarters;
    private DDbBranchAddress moBizPartnerBranchAddressOfficial;
    private DDbConfigCompany moConfigCompany;
    private DDbConfigBranch moConfigBranch;
    private DDbBranchCash moBranchCash;
    private DDialogFindBizPartner moDialogFindBizPartner;
    private DDialogCfdRelations moDialogCfdRelations;
    private DDialogDpsInvoicePicker moDialogDpsInvoicePicker;
    private DGridPaneForm moGridPayments;
    private DGridPaneForm moGridPaymentDocs;
    private Date mtOriginalDate;
    private int mnOriginalYear;
    private int mnCompanyIdentityType;
    private int mnBizPartnerIdentityType;
    private JButton mjButtonLaunchCalc;

    private DXmlCatalog moXmlCatalogCfdUsage;
    private DXmlCatalog moXmlCatalogModeOfPayment;
    private DXmlCatalog moXmlCatalogCurrency;
    
    private int mnModePayment;      // current edition mode of payment
    private int mnModePaymentDoc;   // current edition mode of payment of document
    private DDbDps moDoc;           // current DPS in edition of payment of document, if any, CFDI can be a third-party's
    private DElementDoctoRelacionado moDoctoRelacionado; // current edited DoctoRelacionado, if new, then it is null
    private double mdDocTotalPayment;

    /** Creates new form DFormDfrPayment
     * @param client GUI client.
     * @param title
     */
    public DFormDfrPayment(DGuiClient client, String title) {
        setFormSettings(client, DGuiConsts.BEAN_FORM_EDIT, DModConsts.TX_DFR_PAY, 0, title);
        initComponents();
        initComponentsCustom();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        bgMode = new javax.swing.ButtonGroup();
        jpContainer = new javax.swing.JPanel();
        jpHeader = new javax.swing.JPanel();
        jpHeaderMain = new javax.swing.JPanel();
        jpHeaderMain1 = new javax.swing.JPanel();
        moKeyReceiver = new sba.lib.gui.bean.DBeanFieldKey();
        jtfDfrReceiverFiscalId = new javax.swing.JTextField();
        jtfDfrReceiverFiscalAddress = new javax.swing.JTextField();
        jbReceiverPick = new javax.swing.JButton();
        jbReceiverEdit = new javax.swing.JButton();
        jlNumber = new javax.swing.JLabel();
        moTextSeries = new sba.lib.gui.bean.DBeanFieldText();
        moIntNumber = new sba.lib.gui.bean.DBeanFieldInteger();
        jlDateDate = new javax.swing.JLabel();
        moDateDate = new sba.lib.gui.bean.DBeanFieldDate();
        jtfDocType = new javax.swing.JTextField();
        jpHeaderMain2 = new javax.swing.JPanel();
        moKeyDfrReceiverTaxRegime = new sba.lib.gui.bean.DBeanFieldKey();
        moKeyDfrCfdUsage = new sba.lib.gui.bean.DBeanFieldKey();
        jlDummyCurrency = new javax.swing.JLabel();
        moKeyDummyCurrency = new sba.lib.gui.bean.DBeanFieldKey();
        jlDummyExchangeRate = new javax.swing.JLabel();
        moDecDummyExchangeRate = new sba.lib.gui.bean.DBeanFieldDecimal();
        jbDummyExchangeRatePick = new javax.swing.JButton();
        jtfDocStatus = new javax.swing.JTextField();
        jpDfr1 = new javax.swing.JPanel();
        jpDfr11 = new javax.swing.JPanel();
        jlCfdType = new javax.swing.JLabel();
        jtfCfdType = new javax.swing.JTextField();
        jtfCfdStatus = new javax.swing.JTextField();
        jtfDfrPlaceOfIssue = new javax.swing.JTextField();
        jlDfrConfirmation = new javax.swing.JLabel();
        moTextDfrConfirmation = new sba.lib.gui.bean.DBeanFieldText();
        jpDfr12 = new javax.swing.JPanel();
        jlDfrIssuerTaxRegime = new javax.swing.JLabel();
        moKeyDfrIssuerTaxRegime = new sba.lib.gui.bean.DBeanFieldKey();
        jpDfr13 = new javax.swing.JPanel();
        jlDfrCfdRelations = new javax.swing.JLabel();
        jtfDfrCfdRelations = new javax.swing.JTextField();
        jbDfrCfdRelationsEdit = new javax.swing.JButton();
        jpDfr2 = new javax.swing.JPanel();
        jpDfr21 = new javax.swing.JPanel();
        jpDfr22 = new javax.swing.JPanel();
        jlMode = new javax.swing.JLabel();
        moRadModeEmit = new sba.lib.gui.bean.DBeanFieldRadio();
        moRadModeEmitPay = new sba.lib.gui.bean.DBeanFieldRadio();
        jpDfr23 = new javax.swing.JPanel();
        jlCfdInfo = new javax.swing.JLabel();
        jtfDfrVersion = new javax.swing.JTextField();
        jtfDfrCfdType = new javax.swing.JTextField();
        jtfDfrDatetime = new javax.swing.JTextField();
        jtfDfrUuid = new javax.swing.JTextField();
        jpBody = new javax.swing.JPanel();
        jpPayments = new javax.swing.JPanel();
        jpPaymentsInput = new javax.swing.JPanel();
        jPanel48 = new javax.swing.JPanel();
        jPanel50 = new javax.swing.JPanel();
        jlPayDatetime = new javax.swing.JLabel();
        moDatePayDate = new sba.lib.gui.bean.DBeanFieldDate();
        moTextPayTime = new sba.lib.gui.bean.DBeanFieldText();
        jPanel51 = new javax.swing.JPanel();
        jlPayModeOfPaymentType = new javax.swing.JLabel();
        moKeyPayModeOfPaymentType = new sba.lib.gui.bean.DBeanFieldKey();
        jPanel2 = new javax.swing.JPanel();
        jlPayCurrency = new javax.swing.JLabel();
        moKeyPayCurrency = new sba.lib.gui.bean.DBeanFieldKey();
        jPanel6 = new javax.swing.JPanel();
        jlPayExchangeRate = new javax.swing.JLabel();
        moDecPayExchangeRate = new sba.lib.gui.bean.DBeanFieldDecimal();
        jbPayExchangeRatePick = new javax.swing.JButton();
        jPanel4 = new javax.swing.JPanel();
        jlPayAmountPay = new javax.swing.JLabel();
        moCurPayAmountPay = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        jPanel5 = new javax.swing.JPanel();
        jlPayAmountLoc = new javax.swing.JLabel();
        moCurPayAmountLoc = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        jPanel11 = new javax.swing.JPanel();
        jbPayAdd = new javax.swing.JButton();
        jbPayModify = new javax.swing.JButton();
        jbPayDelete = new javax.swing.JButton();
        jPanel49 = new javax.swing.JPanel();
        jPanel14 = new javax.swing.JPanel();
        jlPayOperation = new javax.swing.JLabel();
        moTextPayOperation = new sba.lib.gui.bean.DBeanFieldText();
        jPanel10 = new javax.swing.JPanel();
        jlPayPayersBank = new javax.swing.JLabel();
        moTextPayPayersBank = new sba.lib.gui.bean.DBeanFieldText();
        jPanel52 = new javax.swing.JPanel();
        jlPayPayersBankFiscalId = new javax.swing.JLabel();
        moTextPayPayersBankFiscalId = new sba.lib.gui.bean.DBeanFieldText();
        jPanel53 = new javax.swing.JPanel();
        jlPayPayersAccount = new javax.swing.JLabel();
        moTextPayPayersAccount = new sba.lib.gui.bean.DBeanFieldText();
        jPanel8 = new javax.swing.JPanel();
        jlPayRecipientsBankFiscalId = new javax.swing.JLabel();
        moTextPayRecipientsBankFiscalId = new sba.lib.gui.bean.DBeanFieldText();
        jPanel9 = new javax.swing.JPanel();
        jlPayRecipientsAccount = new javax.swing.JLabel();
        moTextPayRecipientsAccount = new sba.lib.gui.bean.DBeanFieldText();
        jPanel12 = new javax.swing.JPanel();
        jbPayOk = new javax.swing.JButton();
        jbPayCancel = new javax.swing.JButton();
        jpPaymentsControls = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        jlTotalCfd = new javax.swing.JLabel();
        moCurTotalCfdPay = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        moCurTotalCfdLoc = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        jPanel16 = new javax.swing.JPanel();
        jtfOwnBranch = new javax.swing.JTextField();
        jtfBranchCash = new javax.swing.JTextField();
        jpPaymentDocs = new javax.swing.JPanel();
        jpPaymentDocsInput = new javax.swing.JPanel();
        jPanel54 = new javax.swing.JPanel();
        jPanel55 = new javax.swing.JPanel();
        jlDocNumber = new javax.swing.JLabel();
        moTextDocSeries = new sba.lib.gui.bean.DBeanFieldText();
        moIntDocNumber = new sba.lib.gui.bean.DBeanFieldInteger();
        moTextDocUuid = new sba.lib.gui.bean.DBeanFieldText();
        jbDocPick = new javax.swing.JButton();
        jPanel18 = new javax.swing.JPanel();
        jlDocCurrency = new javax.swing.JLabel();
        moKeyDocCurrency = new sba.lib.gui.bean.DBeanFieldKey();
        jPanel19 = new javax.swing.JPanel();
        jlDocExchangeRate = new javax.swing.JLabel();
        moDecDocExchangeRate = new sba.lib.gui.bean.DBeanFieldDecimal();
        jbDocExchangeRatePick = new javax.swing.JButton();
        jbDocExchangeRateInvert = new javax.swing.JButton();
        jtfDocExchangeRate = new javax.swing.JTextField();
        jlDocInstallment = new javax.swing.JLabel();
        moIntDocInstallment = new sba.lib.gui.bean.DBeanFieldInteger();
        jPanel24 = new javax.swing.JPanel();
        jlDocBalancePrev = new javax.swing.JLabel();
        moCurDocBalancePrevDoc = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        moCurDocBalancePrevPay = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        jPanel26 = new javax.swing.JPanel();
        jlDocPayment = new javax.swing.JLabel();
        moCurDocPaymentDoc = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        moCurDocPaymentPay = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        jPanel56 = new javax.swing.JPanel();
        jlDocBalancePend = new javax.swing.JLabel();
        moCurDocBalancePendDoc = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        moCurDocBalancePendPay = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        jPanel27 = new javax.swing.JPanel();
        jPanel28 = new javax.swing.JPanel();
        jbDocAdd = new javax.swing.JButton();
        jbDocModify = new javax.swing.JButton();
        jbDocDelete = new javax.swing.JButton();
        jPanel29 = new javax.swing.JPanel();
        jbDocOk = new javax.swing.JButton();
        jbDocCancel = new javax.swing.JButton();
        jpPaymentDocsControls = new javax.swing.JPanel();
        jlTotalPayment = new javax.swing.JLabel();
        moCurTotalPaymentPay = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();
        moCurTotalPaymentLoc = new sba.lib.gui.bean.DBeanCompoundFieldCurrency();

        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                formWindowClosing(evt);
            }
        });

        jpContainer.setLayout(new java.awt.BorderLayout());

        jpHeader.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del documento:"));
        jpHeader.setLayout(new java.awt.BorderLayout(5, 5));

        jpHeaderMain.setLayout(new java.awt.GridLayout(2, 1, 0, 5));

        jpHeaderMain1.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 4, 0));

        moKeyReceiver.setToolTipText("Receptor");
        moKeyReceiver.setPreferredSize(new java.awt.Dimension(350, 23));
        jpHeaderMain1.add(moKeyReceiver);

        jtfDfrReceiverFiscalId.setEditable(false);
        jtfDfrReceiverFiscalId.setText("XAXX010101000");
        jtfDfrReceiverFiscalId.setToolTipText("RFC");
        jtfDfrReceiverFiscalId.setFocusable(false);
        jtfDfrReceiverFiscalId.setPreferredSize(new java.awt.Dimension(96, 23));
        jpHeaderMain1.add(jtfDfrReceiverFiscalId);

        jtfDfrReceiverFiscalAddress.setEditable(false);
        jtfDfrReceiverFiscalAddress.setText("00000");
        jtfDfrReceiverFiscalAddress.setToolTipText("Domicilio fiscal");
        jtfDfrReceiverFiscalAddress.setFocusable(false);
        jtfDfrReceiverFiscalAddress.setPreferredSize(new java.awt.Dimension(50, 23));
        jpHeaderMain1.add(jtfDfrReceiverFiscalAddress);

        jbReceiverPick.setText("...");
        jbReceiverPick.setToolTipText("Buscar receptor [F9]");
        jbReceiverPick.setPreferredSize(new java.awt.Dimension(23, 23));
        jpHeaderMain1.add(jbReceiverPick);

        jbReceiverEdit.setIcon(new javax.swing.ImageIcon(getClass().getResource("/sba/gui/img/cmd_std_edit.gif"))); // NOI18N
        jbReceiverEdit.setToolTipText("Modificar ...");
        jbReceiverEdit.setPreferredSize(new java.awt.Dimension(23, 23));
        jpHeaderMain1.add(jbReceiverEdit);

        jlNumber.setText("Folio:*");
        jlNumber.setPreferredSize(new java.awt.Dimension(55, 23));
        jlNumber.setRequestFocusEnabled(false);
        jpHeaderMain1.add(jlNumber);

        moTextSeries.setEditable(false);
        moTextSeries.setText("TEXT");
        moTextSeries.setToolTipText("Serie");
        moTextSeries.setPreferredSize(new java.awt.Dimension(50, 23));
        jpHeaderMain1.add(moTextSeries);

        moIntNumber.setEditable(false);
        moIntNumber.setText("999999999");
        moIntNumber.setToolTipText("Folio");
        moIntNumber.setPreferredSize(new java.awt.Dimension(75, 23));
        jpHeaderMain1.add(moIntNumber);

        jlDateDate.setText("Fecha:*");
        jlDateDate.setPreferredSize(new java.awt.Dimension(60, 23));
        jpHeaderMain1.add(jlDateDate);

        moDateDate.setPreferredSize(new java.awt.Dimension(100, 23));
        jpHeaderMain1.add(moDateDate);

        jtfDocType.setEditable(false);
        jtfDocType.setText("TEXT");
        jtfDocType.setToolTipText("Tipo de documento");
        jtfDocType.setFocusable(false);
        jtfDocType.setPreferredSize(new java.awt.Dimension(75, 23));
        jpHeaderMain1.add(jtfDocType);

        jpHeaderMain.add(jpHeaderMain1);

        jpHeaderMain2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 4, 0));

        moKeyDfrReceiverTaxRegime.setToolTipText("Régimen fiscal del receptor");
        moKeyDfrReceiverTaxRegime.setPreferredSize(new java.awt.Dimension(350, 23));
        jpHeaderMain2.add(moKeyDfrReceiverTaxRegime);

        moKeyDfrCfdUsage.setToolTipText("Uso del CFDI");
        moKeyDfrCfdUsage.setPreferredSize(new java.awt.Dimension(204, 23));
        jpHeaderMain2.add(moKeyDfrCfdUsage);

        jlDummyCurrency.setText("Moneda:*");
        jlDummyCurrency.setPreferredSize(new java.awt.Dimension(55, 23));
        jlDummyCurrency.setRequestFocusEnabled(false);
        jpHeaderMain2.add(jlDummyCurrency);

        moKeyDummyCurrency.setPreferredSize(new java.awt.Dimension(129, 23));
        jpHeaderMain2.add(moKeyDummyCurrency);

        jlDummyExchangeRate.setText("T. cambio:*");
        jlDummyExchangeRate.setPreferredSize(new java.awt.Dimension(60, 23));
        jpHeaderMain2.add(jlDummyExchangeRate);

        moDecDummyExchangeRate.setPreferredSize(new java.awt.Dimension(73, 23));
        jpHeaderMain2.add(moDecDummyExchangeRate);

        jbDummyExchangeRatePick.setText("...");
        jbDummyExchangeRatePick.setToolTipText("Buscar tipo de cambio");
        jbDummyExchangeRatePick.setPreferredSize(new java.awt.Dimension(23, 23));
        jpHeaderMain2.add(jbDummyExchangeRatePick);

        jtfDocStatus.setEditable(false);
        jtfDocStatus.setText("TEXT");
        jtfDocStatus.setToolTipText("Estatus del documento");
        jtfDocStatus.setFocusable(false);
        jtfDocStatus.setPreferredSize(new java.awt.Dimension(75, 23));
        jpHeaderMain2.add(jtfDocStatus);

        jpHeaderMain.add(jpHeaderMain2);

        jpHeader.add(jpHeaderMain, java.awt.BorderLayout.NORTH);

        jpDfr1.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jpDfr11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlCfdType.setText("Tipo CFDI:");
        jlCfdType.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr11.add(jlCfdType);

        jtfCfdType.setEditable(false);
        jtfCfdType.setText("TEXT");
        jtfCfdType.setToolTipText("Tipo de comprobante");
        jtfCfdType.setFocusable(false);
        jtfCfdType.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr11.add(jtfCfdType);

        jtfCfdStatus.setEditable(false);
        jtfCfdStatus.setText("TEXT");
        jtfCfdStatus.setToolTipText("Estatus del comprobante");
        jtfCfdStatus.setFocusable(false);
        jtfCfdStatus.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr11.add(jtfCfdStatus);

        jtfDfrPlaceOfIssue.setEditable(false);
        jtfDfrPlaceOfIssue.setText("00000");
        jtfDfrPlaceOfIssue.setToolTipText("Lugar de expedición");
        jtfDfrPlaceOfIssue.setFocusable(false);
        jtfDfrPlaceOfIssue.setPreferredSize(new java.awt.Dimension(50, 23));
        jpDfr11.add(jtfDfrPlaceOfIssue);

        jlDfrConfirmation.setForeground(new java.awt.Color(0, 102, 102));
        jlDfrConfirmation.setText("Confirmación:");
        jlDfrConfirmation.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr11.add(jlDfrConfirmation);

        moTextDfrConfirmation.setText("TEXT");
        moTextDfrConfirmation.setPreferredSize(new java.awt.Dimension(50, 23));
        jpDfr11.add(moTextDfrConfirmation);

        jpDfr1.add(jpDfr11);

        jpDfr12.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDfrIssuerTaxRegime.setText("Régimen:*");
        jlDfrIssuerTaxRegime.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr12.add(jlDfrIssuerTaxRegime);

        moKeyDfrIssuerTaxRegime.setToolTipText("Régimen fiscal del emisor");
        moKeyDfrIssuerTaxRegime.setPreferredSize(new java.awt.Dimension(345, 23));
        jpDfr12.add(moKeyDfrIssuerTaxRegime);

        jpDfr1.add(jpDfr12);

        jpDfr13.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDfrCfdRelations.setText("Relaciones:");
        jlDfrCfdRelations.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr13.add(jlDfrCfdRelations);

        jtfDfrCfdRelations.setEditable(false);
        jtfDfrCfdRelations.setText("TEXT");
        jtfDfrCfdRelations.setToolTipText("CFDI relacionados");
        jtfDfrCfdRelations.setFocusable(false);
        jtfDfrCfdRelations.setPreferredSize(new java.awt.Dimension(317, 23));
        jpDfr13.add(jtfDfrCfdRelations);

        jbDfrCfdRelationsEdit.setText("...");
        jbDfrCfdRelationsEdit.setToolTipText("Gestionar CFDI relacionados");
        jbDfrCfdRelationsEdit.setPreferredSize(new java.awt.Dimension(23, 23));
        jpDfr13.add(jbDfrCfdRelationsEdit);

        jpDfr1.add(jpDfr13);

        jpHeader.add(jpDfr1, java.awt.BorderLayout.CENTER);

        jpDfr2.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jpDfr21.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));
        jpDfr2.add(jpDfr21);

        jpDfr22.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlMode.setText("Modalidad:");
        jlMode.setPreferredSize(new java.awt.Dimension(75, 23));
        jlMode.setRequestFocusEnabled(false);
        jpDfr22.add(jlMode);

        bgMode.add(moRadModeEmit);
        moRadModeEmit.setText("Emitir CFDI solamente");
        moRadModeEmit.setPreferredSize(new java.awt.Dimension(150, 23));
        jpDfr22.add(moRadModeEmit);

        bgMode.add(moRadModeEmitPay);
        moRadModeEmitPay.setText("Emitir CFDI y aplicar pagos");
        moRadModeEmitPay.setPreferredSize(new java.awt.Dimension(200, 23));
        jpDfr22.add(moRadModeEmitPay);

        jpDfr2.add(jpDfr22);

        jpDfr23.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlCfdInfo.setText("Info. CFDI:");
        jlCfdInfo.setPreferredSize(new java.awt.Dimension(75, 23));
        jpDfr23.add(jlCfdInfo);

        jtfDfrVersion.setEditable(false);
        jtfDfrVersion.setText("1.0");
        jtfDfrVersion.setToolTipText("Versión del comprobante");
        jtfDfrVersion.setFocusable(false);
        jtfDfrVersion.setPreferredSize(new java.awt.Dimension(30, 23));
        jpDfr23.add(jtfDfrVersion);

        jtfDfrCfdType.setEditable(false);
        jtfDfrCfdType.setText("T");
        jtfDfrCfdType.setToolTipText("Tipo de comprobante");
        jtfDfrCfdType.setFocusable(false);
        jtfDfrCfdType.setPreferredSize(new java.awt.Dimension(30, 23));
        jpDfr23.add(jtfDfrCfdType);

        jtfDfrDatetime.setEditable(false);
        jtfDfrDatetime.setText("01/01/2001 00:00:00");
        jtfDfrDatetime.setToolTipText("Fecha-hora del comprobante");
        jtfDfrDatetime.setFocusable(false);
        jtfDfrDatetime.setPreferredSize(new java.awt.Dimension(120, 23));
        jpDfr23.add(jtfDfrDatetime);

        jtfDfrUuid.setEditable(false);
        jtfDfrUuid.setText("F5343B75-9A23-4E25-979A-03CA560FEE62");
        jtfDfrUuid.setToolTipText("UUID del comprobante");
        jtfDfrUuid.setFocusable(false);
        jtfDfrUuid.setPreferredSize(new java.awt.Dimension(225, 23));
        jpDfr23.add(jtfDfrUuid);

        jpDfr2.add(jpDfr23);

        jpHeader.add(jpDfr2, java.awt.BorderLayout.EAST);

        jpContainer.add(jpHeader, java.awt.BorderLayout.NORTH);

        jpBody.setLayout(new java.awt.BorderLayout(0, 5));

        jpPayments.setBorder(javax.swing.BorderFactory.createTitledBorder("Pagos:"));
        jpPayments.setLayout(new java.awt.BorderLayout());

        jpPaymentsInput.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 0, 0));

        jPanel48.setLayout(new java.awt.GridLayout(7, 1, 0, 5));

        jPanel50.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayDatetime.setText("Fecha pago:*");
        jlPayDatetime.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel50.add(jlPayDatetime);
        jPanel50.add(moDatePayDate);

        moTextPayTime.setText("12:00:00");
        moTextPayTime.setToolTipText("Hora (HH:mm:ss)");
        moTextPayTime.setPreferredSize(new java.awt.Dimension(67, 23));
        jPanel50.add(moTextPayTime);

        jPanel48.add(jPanel50);

        jPanel51.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayModeOfPaymentType.setText("Forma pago:*");
        jlPayModeOfPaymentType.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel51.add(jlPayModeOfPaymentType);

        moKeyPayModeOfPaymentType.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel51.add(moKeyPayModeOfPaymentType);

        jPanel48.add(jPanel51);

        jPanel2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayCurrency.setText("Moneda:*");
        jlPayCurrency.setPreferredSize(new java.awt.Dimension(75, 23));
        jlPayCurrency.setRequestFocusEnabled(false);
        jPanel2.add(jlPayCurrency);

        moKeyPayCurrency.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel2.add(moKeyPayCurrency);

        jPanel48.add(jPanel2);

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayExchangeRate.setText("T. cambio:*");
        jlPayExchangeRate.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel6.add(jlPayExchangeRate);

        moDecPayExchangeRate.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel6.add(moDecPayExchangeRate);

        jbPayExchangeRatePick.setText("...");
        jbPayExchangeRatePick.setToolTipText("Buscar tipo de cambio");
        jbPayExchangeRatePick.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel6.add(jbPayExchangeRatePick);

        jPanel48.add(jPanel6);

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayAmountPay.setText("Monto pago:*");
        jlPayAmountPay.setPreferredSize(new java.awt.Dimension(75, 23));
        jlPayAmountPay.setRequestFocusEnabled(false);
        jPanel4.add(jlPayAmountPay);
        jPanel4.add(moCurPayAmountPay);

        jPanel48.add(jPanel4);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayAmountLoc.setPreferredSize(new java.awt.Dimension(75, 23));
        jlPayAmountLoc.setRequestFocusEnabled(false);
        jPanel5.add(jlPayAmountLoc);

        moCurPayAmountLoc.setEditable(false);
        jPanel5.add(moCurPayAmountLoc);

        jPanel48.add(jPanel5);

        jPanel11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jbPayAdd.setText("Agregar");
        jbPayAdd.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel11.add(jbPayAdd);

        jbPayModify.setText("Modificar");
        jbPayModify.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel11.add(jbPayModify);

        jbPayDelete.setText("Eliminar");
        jbPayDelete.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel11.add(jbPayDelete);

        jPanel48.add(jPanel11);

        jpPaymentsInput.add(jPanel48);

        jPanel49.setLayout(new java.awt.GridLayout(7, 1, 0, 5));

        jPanel14.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayOperation.setText("# Operación:");
        jlPayOperation.setPreferredSize(new java.awt.Dimension(100, 23));
        jlPayOperation.setRequestFocusEnabled(false);
        jPanel14.add(jlPayOperation);

        moTextPayOperation.setText("TEXT");
        moTextPayOperation.setPreferredSize(new java.awt.Dimension(130, 23));
        jPanel14.add(moTextPayOperation);

        jPanel49.add(jPanel14);

        jPanel10.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayPayersBank.setText("Nombre emisor CO:");
        jlPayPayersBank.setToolTipText("Banco emisor cuenta ordenante");
        jlPayPayersBank.setPreferredSize(new java.awt.Dimension(100, 23));
        jlPayPayersBank.setRequestFocusEnabled(false);
        jPanel10.add(jlPayPayersBank);

        moTextPayPayersBank.setText("TEXT");
        moTextPayPayersBank.setPreferredSize(new java.awt.Dimension(130, 23));
        jPanel10.add(moTextPayPayersBank);

        jPanel49.add(jPanel10);

        jPanel52.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayPayersBankFiscalId.setText("RFC emisor CO:");
        jlPayPayersBankFiscalId.setToolTipText("RFC emisor cuenta ordenante");
        jlPayPayersBankFiscalId.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel52.add(jlPayPayersBankFiscalId);

        moTextPayPayersBankFiscalId.setText("TEXT");
        moTextPayPayersBankFiscalId.setPreferredSize(new java.awt.Dimension(130, 23));
        jPanel52.add(moTextPayPayersBankFiscalId);

        jPanel49.add(jPanel52);

        jPanel53.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayPayersAccount.setText("# Cta. Ordenante:");
        jlPayPayersAccount.setToolTipText("Número cuenta ordenante");
        jlPayPayersAccount.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel53.add(jlPayPayersAccount);

        moTextPayPayersAccount.setText("TEXT");
        moTextPayPayersAccount.setPreferredSize(new java.awt.Dimension(130, 23));
        jPanel53.add(moTextPayPayersAccount);

        jPanel49.add(jPanel53);

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayRecipientsBankFiscalId.setText("RFC emisor CB:");
        jlPayRecipientsBankFiscalId.setToolTipText("RFC emisor cuenta beneficiario");
        jlPayRecipientsBankFiscalId.setPreferredSize(new java.awt.Dimension(100, 23));
        jlPayRecipientsBankFiscalId.setRequestFocusEnabled(false);
        jPanel8.add(jlPayRecipientsBankFiscalId);

        moTextPayRecipientsBankFiscalId.setText("TEXT");
        moTextPayRecipientsBankFiscalId.setPreferredSize(new java.awt.Dimension(130, 23));
        jPanel8.add(moTextPayRecipientsBankFiscalId);

        jPanel49.add(jPanel8);

        jPanel9.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPayRecipientsAccount.setText("# Cta. Beneficiario:");
        jlPayRecipientsAccount.setToolTipText("Número cuenta beneficiario");
        jlPayRecipientsAccount.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel9.add(jlPayRecipientsAccount);

        moTextPayRecipientsAccount.setText("TEXT");
        moTextPayRecipientsAccount.setPreferredSize(new java.awt.Dimension(130, 23));
        jPanel9.add(moTextPayRecipientsAccount);

        jPanel49.add(jPanel9);

        jPanel12.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT, 5, 0));

        jbPayOk.setText("Aceptar");
        jbPayOk.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel12.add(jbPayOk);

        jbPayCancel.setText("Cancelar");
        jbPayCancel.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel12.add(jbPayCancel);

        jPanel49.add(jPanel12);

        jpPaymentsInput.add(jPanel49);

        jpPayments.add(jpPaymentsInput, java.awt.BorderLayout.PAGE_START);

        jpPaymentsControls.setLayout(new java.awt.BorderLayout());

        jPanel1.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));

        jlTotalCfd.setText("Total pagos:");
        jlTotalCfd.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel1.add(jlTotalCfd);

        moCurTotalCfdPay.setEditable(false);
        jPanel1.add(moCurTotalCfdPay);

        moCurTotalCfdLoc.setEditable(false);
        jPanel1.add(moCurTotalCfdLoc);

        jpPaymentsControls.add(jPanel1, java.awt.BorderLayout.WEST);

        jtfOwnBranch.setEditable(false);
        jtfOwnBranch.setText("TEXT");
        jtfOwnBranch.setToolTipText(DUtilConsts.TXT_BRANCH);
        jtfOwnBranch.setFocusable(false);
        jtfOwnBranch.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel16.add(jtfOwnBranch);

        jtfBranchCash.setEditable(false);
        jtfBranchCash.setText("TEXT");
        jtfBranchCash.setToolTipText(DUtilConsts.TXT_BRANCH_CSH);
        jtfBranchCash.setFocusable(false);
        jtfBranchCash.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel16.add(jtfBranchCash);

        jpPaymentsControls.add(jPanel16, java.awt.BorderLayout.EAST);

        jpPayments.add(jpPaymentsControls, java.awt.BorderLayout.SOUTH);

        jpBody.add(jpPayments, java.awt.BorderLayout.WEST);

        jpPaymentDocs.setBorder(javax.swing.BorderFactory.createTitledBorder("Documentos relacionados:"));
        jpPaymentDocs.setLayout(new java.awt.BorderLayout());

        jpPaymentDocsInput.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 0, 0));

        jPanel54.setLayout(new java.awt.GridLayout(7, 1, 0, 5));

        jPanel55.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDocNumber.setText("Folio DR:*");
        jlDocNumber.setToolTipText("Folio documento relacionado");
        jlDocNumber.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel55.add(jlDocNumber);

        moTextDocSeries.setText("TEXT");
        moTextDocSeries.setToolTipText("Serie");
        moTextDocSeries.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel55.add(moTextDocSeries);

        moIntDocNumber.setText("999999");
        moIntDocNumber.setToolTipText("Folio");
        moIntDocNumber.setPreferredSize(new java.awt.Dimension(60, 23));
        jPanel55.add(moIntDocNumber);

        moTextDocUuid.setText("F5343B75-9A23-4E25-979A-03CA560FEE62");
        moTextDocUuid.setPreferredSize(new java.awt.Dimension(225, 23));
        jPanel55.add(moTextDocUuid);

        jbDocPick.setText("...");
        jbDocPick.setToolTipText("Buscar documento relacionado (DR)");
        jbDocPick.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel55.add(jbDocPick);

        jPanel54.add(jPanel55);

        jPanel18.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDocCurrency.setText("Moneda DR:*");
        jlDocCurrency.setToolTipText("Moneda documento relacionado");
        jlDocCurrency.setPreferredSize(new java.awt.Dimension(100, 23));
        jlDocCurrency.setRequestFocusEnabled(false);
        jPanel18.add(jlDocCurrency);

        moKeyDocCurrency.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel18.add(moKeyDocCurrency);

        jPanel54.add(jPanel18);

        jPanel19.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDocExchangeRate.setText("T. cambio:*");
        jlDocExchangeRate.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel19.add(jlDocExchangeRate);

        moDecDocExchangeRate.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel19.add(moDecDocExchangeRate);

        jbDocExchangeRatePick.setText("...");
        jbDocExchangeRatePick.setToolTipText("Buscar tipo de cambio");
        jbDocExchangeRatePick.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel19.add(jbDocExchangeRatePick);

        jbDocExchangeRateInvert.setIcon(new javax.swing.ImageIcon(getClass().getResource("/sba/gui/img/cmd_std_mon.gif"))); // NOI18N
        jbDocExchangeRateInvert.setToolTipText("Invertir tipo de cambio (1/x)");
        jbDocExchangeRateInvert.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel19.add(jbDocExchangeRateInvert);

        jtfDocExchangeRate.setEditable(false);
        jtfDocExchangeRate.setText("TEXT");
        jtfDocExchangeRate.setFocusable(false);
        jtfDocExchangeRate.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel19.add(jtfDocExchangeRate);

        jlDocInstallment.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlDocInstallment.setText("Parcialidad DR:*");
        jlDocInstallment.setToolTipText("Parcialidad documento relacionado");
        jlDocInstallment.setPreferredSize(new java.awt.Dimension(100, 23));
        jlDocInstallment.setRequestFocusEnabled(false);
        jPanel19.add(jlDocInstallment);

        moIntDocInstallment.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel19.add(moIntDocInstallment);

        jPanel54.add(jPanel19);

        jPanel24.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDocBalancePrev.setText("Saldo anterior:*");
        jlDocBalancePrev.setPreferredSize(new java.awt.Dimension(100, 23));
        jlDocBalancePrev.setRequestFocusEnabled(false);
        jPanel24.add(jlDocBalancePrev);
        jPanel24.add(moCurDocBalancePrevDoc);

        moCurDocBalancePrevPay.setEditable(false);
        jPanel24.add(moCurDocBalancePrevPay);

        jPanel54.add(jPanel24);

        jPanel26.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDocPayment.setText("Importe pagado:*");
        jlDocPayment.setPreferredSize(new java.awt.Dimension(100, 23));
        jlDocPayment.setRequestFocusEnabled(false);
        jPanel26.add(jlDocPayment);
        jPanel26.add(moCurDocPaymentDoc);

        moCurDocPaymentPay.setEditable(false);
        jPanel26.add(moCurDocPaymentPay);

        jPanel54.add(jPanel26);

        jPanel56.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDocBalancePend.setText("Saldo insoluto:*");
        jlDocBalancePend.setPreferredSize(new java.awt.Dimension(100, 23));
        jlDocBalancePend.setRequestFocusEnabled(false);
        jPanel56.add(jlDocBalancePend);

        moCurDocBalancePendDoc.setEditable(false);
        jPanel56.add(moCurDocBalancePendDoc);

        moCurDocBalancePendPay.setEditable(false);
        jPanel56.add(moCurDocBalancePendPay);

        jPanel54.add(jPanel56);

        jPanel27.setLayout(new java.awt.BorderLayout());

        jPanel28.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jbDocAdd.setText("Agregar");
        jbDocAdd.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel28.add(jbDocAdd);

        jbDocModify.setText("Modificar");
        jbDocModify.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel28.add(jbDocModify);

        jbDocDelete.setText("Eliminar");
        jbDocDelete.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel28.add(jbDocDelete);

        jPanel27.add(jPanel28, java.awt.BorderLayout.CENTER);

        jPanel29.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT, 5, 0));

        jbDocOk.setText("Aceptar");
        jbDocOk.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel29.add(jbDocOk);

        jbDocCancel.setText("Cancelar");
        jbDocCancel.setPreferredSize(new java.awt.Dimension(80, 23));
        jPanel29.add(jbDocCancel);

        jPanel27.add(jPanel29, java.awt.BorderLayout.EAST);

        jPanel54.add(jPanel27);

        jpPaymentDocsInput.add(jPanel54);

        jpPaymentDocs.add(jpPaymentDocsInput, java.awt.BorderLayout.PAGE_START);

        jpPaymentDocsControls.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));

        jlTotalPayment.setText("Total documentos:");
        jlTotalPayment.setPreferredSize(new java.awt.Dimension(100, 23));
        jpPaymentDocsControls.add(jlTotalPayment);

        moCurTotalPaymentPay.setEditable(false);
        jpPaymentDocsControls.add(moCurTotalPaymentPay);

        moCurTotalPaymentLoc.setEditable(false);
        jpPaymentDocsControls.add(moCurTotalPaymentLoc);

        jpPaymentDocs.add(jpPaymentDocsControls, java.awt.BorderLayout.PAGE_END);

        jpBody.add(jpPaymentDocs, java.awt.BorderLayout.CENTER);

        jpContainer.add(jpBody, java.awt.BorderLayout.CENTER);

        getContentPane().add(jpContainer, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowClosing(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowClosing
        freeLockByCancel();
    }//GEN-LAST:event_formWindowClosing

    /*
     * Private methods
     */
    
    private void initComponentsCustom() {
        DGuiUtils.setWindowBounds(this, 1024, 640);

        moKeyReceiver.setKeySettings(miClient, "receptor", true);
        moKeyReceiver.setFieldButton(jbReceiverPick);
        moTextSeries.setTextSettings(DGuiUtils.getLabelName(jlNumber), 10, 0);
        moIntNumber.setIntegerSettings(DGuiUtils.getLabelName(jlNumber), DGuiConsts.GUI_TYPE_INT_RAW, true);
        moDateDate.setDateSettings(miClient, DGuiUtils.getLabelName(jlDateDate), true);
        moKeyDfrReceiverTaxRegime.setKeySettings(miClient, moKeyDfrReceiverTaxRegime.getToolTipText(), true);
        moKeyDfrCfdUsage.setKeySettings(miClient, moKeyDfrCfdUsage.getToolTipText(), true);
        moKeyDummyCurrency.setKeySettings(miClient, DGuiUtils.getLabelName(jlDummyCurrency), true);
        moDecDummyExchangeRate.setDecimalSettings(DGuiUtils.getLabelName(jlDummyExchangeRate), DGuiConsts.GUI_TYPE_DEC_EXC_RATE, true);
        moDecDummyExchangeRate.setFieldButton(jbDummyExchangeRatePick);
        moRadModeEmit.setBooleanSettings(moRadModeEmit.getText(), false);
        moRadModeEmitPay.setBooleanSettings(moRadModeEmitPay.getText(), false);
        
        moTextDfrConfirmation.setTextSettings(DGuiUtils.getLabelName(jlDfrConfirmation), 5, 0);
        moTextDfrConfirmation.setTextCaseType(0);
        moKeyDfrIssuerTaxRegime.setKeySettings(miClient, DGuiUtils.getLabelName(jlDfrIssuerTaxRegime), true);
        
        moDatePayDate.setDateSettings(miClient, DGuiUtils.getLabelName(jlPayDatetime), true);
        moTextPayTime.setTextSettings(DGuiUtils.getLabelName(jlPayDatetime), 8, 8); // HH:mm:ss
        moKeyPayModeOfPaymentType.setKeySettings(miClient, DGuiUtils.getLabelName(jlPayModeOfPaymentType), true);
        moKeyPayCurrency.setKeySettings(miClient, DGuiUtils.getLabelName(jlPayCurrency), true);
        moDecPayExchangeRate.setDecimalSettings(DGuiUtils.getLabelName(jlPayExchangeRate), DGuiConsts.GUI_TYPE_DEC_EXC_RATE, true);
        moDecPayExchangeRate.setFieldButton(jbPayExchangeRatePick);
        moCurPayAmountPay.setCompoundFieldSettings(miClient);
        moCurPayAmountPay.getField().setDecimalSettings(DGuiUtils.getLabelName(jlPayAmountPay), DGuiConsts.GUI_TYPE_DEC_AMT, true);
        moCurPayAmountLoc.setCompoundFieldSettings(miClient);
        moCurPayAmountLoc.getField().setDecimalSettings(DGuiUtils.getLabelName(jlPayAmountLoc), DGuiConsts.GUI_TYPE_DEC_AMT, true);
        moTextPayOperation.setTextSettings(DGuiUtils.getLabelName(jlPayOperation), 100, 0);
        moTextPayPayersBank.setTextSettings(DGuiUtils.getLabelName(jlPayPayersBank), 300, 0);
        moTextPayPayersBankFiscalId.setTextSettings(DGuiUtils.getLabelName(jlPayPayersBankFiscalId), 13, 0); // RFC
        moTextPayPayersAccount.setTextSettings(DGuiUtils.getLabelName(jlPayPayersAccount), 50, 0);
        moTextPayRecipientsBankFiscalId.setTextSettings(DGuiUtils.getLabelName(jlPayRecipientsBankFiscalId), 13, 0); // RFC
        moTextPayRecipientsAccount.setTextSettings(DGuiUtils.getLabelName(jlPayRecipientsAccount), 50, 0);
        
        moTextDocSeries.setTextSettings(DGuiUtils.getLabelName(jlDocNumber), 10, 0);
        moIntDocNumber.setIntegerSettings(DGuiUtils.getLabelName(jlDocNumber), DGuiConsts.GUI_TYPE_INT_RAW, true);
        moTextDocUuid.setTextSettings(DGuiUtils.getLabelName(jlDocNumber), DCfdVer4Consts.LEN_UUID, DCfdVer4Consts.LEN_UUID);
        moKeyDocCurrency.setKeySettings(miClient, DGuiUtils.getLabelName(jlDocCurrency), true);
        moDecDocExchangeRate.setDecimalSettings(DGuiUtils.getLabelName(jlDocExchangeRate), DGuiConsts.GUI_TYPE_DEC_EXC_RATE, true);
        moDecDocExchangeRate.setFieldButton(jbDocExchangeRatePick);
        moIntDocInstallment.setIntegerSettings(DGuiUtils.getLabelName(jlDocInstallment), DGuiConsts.GUI_TYPE_INT, true);
        moCurDocBalancePrevDoc.setCompoundFieldSettings(miClient);
        moCurDocBalancePrevDoc.getField().setDecimalSettings(DGuiUtils.getLabelName(jlDocBalancePrev), DGuiConsts.GUI_TYPE_DEC_AMT, true);
        moCurDocBalancePrevPay.setCompoundFieldSettings(miClient);
        moCurDocBalancePrevPay.getField().setDecimalSettings(DGuiUtils.getLabelName(jlDocBalancePrev), DGuiConsts.GUI_TYPE_DEC_AMT, true);
        moCurDocPaymentDoc.setCompoundFieldSettings(miClient);
        moCurDocPaymentDoc.getField().setDecimalSettings(DGuiUtils.getLabelName(jlDocPayment), DGuiConsts.GUI_TYPE_DEC_AMT, true);
        moCurDocPaymentPay.setCompoundFieldSettings(miClient);
        moCurDocPaymentPay.getField().setDecimalSettings(DGuiUtils.getLabelName(jlDocPayment), DGuiConsts.GUI_TYPE_DEC_AMT, true);
        moCurDocBalancePendDoc.setCompoundFieldSettings(miClient);
        moCurDocBalancePendDoc.getField().setDecimalSettings(DGuiUtils.getLabelName(jlDocBalancePend), DGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurDocBalancePendPay.setCompoundFieldSettings(miClient);
        moCurDocBalancePendPay.getField().setDecimalSettings(DGuiUtils.getLabelName(jlDocBalancePend), DGuiConsts.GUI_TYPE_DEC_AMT, false);
        
        moCurTotalCfdPay.setCompoundFieldSettings(miClient);
        moCurTotalCfdPay.getField().setDecimalSettings(DGuiUtils.getLabelName(jlTotalCfd), DGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurTotalCfdLoc.setCompoundFieldSettings(miClient);
        moCurTotalCfdLoc.getField().setDecimalSettings(DGuiUtils.getLabelName(jlTotalCfd), DGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurTotalPaymentPay.setCompoundFieldSettings(miClient);
        moCurTotalPaymentPay.getField().setDecimalSettings(DGuiUtils.getLabelName(jlTotalPayment), DGuiConsts.GUI_TYPE_DEC_AMT, false);
        moCurTotalPaymentLoc.setCompoundFieldSettings(miClient);
        moCurTotalPaymentLoc.getField().setDecimalSettings(DGuiUtils.getLabelName(jlTotalPayment), DGuiConsts.GUI_TYPE_DEC_AMT, false);
        
        moFields.addField(moKeyReceiver);
        moFields.addField(moTextSeries);
        moFields.addField(moIntNumber);
        moFields.addField(moDateDate);
        moFields.addField(moKeyDfrReceiverTaxRegime);
        moFields.addField(moKeyDfrCfdUsage);
        moFields.addField(moKeyDummyCurrency);
        moFields.addField(moDecDummyExchangeRate);
        moFields.addField(moRadModeEmit);
        moFields.addField(moRadModeEmitPay);
        
        moFields.addField(moTextDfrConfirmation);
        moFields.addField(moKeyDfrIssuerTaxRegime);
        
        moFields.addField(moDatePayDate);
        moFields.addField(moTextPayTime);
        moFields.addField(moKeyPayModeOfPaymentType);
        moFields.addField(moKeyPayCurrency);
        moFields.addField(moDecPayExchangeRate);
        moFields.addField(moCurPayAmountPay.getField());
        moFields.addField(moCurPayAmountLoc.getField());
        moFields.addField(moTextPayOperation);
        moFields.addField(moTextPayPayersBank);
        moFields.addField(moTextPayPayersBankFiscalId);
        moFields.addField(moTextPayPayersAccount);
        moFields.addField(moTextPayRecipientsBankFiscalId);
        moFields.addField(moTextPayRecipientsAccount);
        
        moFields.addField(moTextDocSeries);
        moFields.addField(moIntDocNumber);
        moFields.addField(moTextDocUuid);
        moFields.addField(moKeyDocCurrency);
        moFields.addField(moDecDocExchangeRate);
        moFields.addField(moIntDocInstallment);
        moFields.addField(moCurDocBalancePrevDoc.getField());
        moFields.addField(moCurDocPaymentDoc.getField());
        
        moTextPayRecipientsAccount.setNextButton(jbPayOk);
        moCurDocPaymentDoc.getField().setNextButton(jbDocOk);

        moFields.setFormButton(jbSave);

        mnCompanyIdentityType = ((DDbBizPartner) miClient.getSession().readRegistry(DModConsts.BU_BPR, new int[] { DUtilConsts.BPR_CO_ID })).getFkIdentityTypeId();

        moXmlCatalogCfdUsage = ((DGuiClientApp) miClient).getXmlCatalogsMap().get(DCfdi40Catalogs.CAT_CFDI_USO);
        moXmlCatalogCfdUsage.populateCatalog(moKeyDfrCfdUsage);

        moXmlCatalogModeOfPayment = ((DGuiClientApp) miClient).getXmlCatalogsMap().get(DCfdi40Catalogs.CAT_FDP);
        moXmlCatalogModeOfPayment.populateCatalog(moKeyPayModeOfPaymentType);

        moXmlCatalogCurrency = ((DGuiClientApp) miClient).getXmlCatalogsMap().get(DCfdi40Catalogs.CAT_MON);
        moXmlCatalogCurrency.populateCatalog(moKeyDummyCurrency);
        moXmlCatalogCurrency.populateCatalog(moKeyPayCurrency);
        moXmlCatalogCurrency.populateCatalog(moKeyDocCurrency);

        moDialogFindBizPartner = new DDialogFindBizPartner(miClient, DModSysConsts.BS_BPR_CL_CUS);
        moDialogCfdRelations = new DDialogCfdRelations(miClient);
        moDialogDpsInvoicePicker = new DDialogDpsInvoicePicker(miClient);

        mjButtonLaunchCalc = DGridUtils.createButton(new ImageIcon(getClass().getResource("/sba/gui/img/cmd_std_cal.gif")), "Mostrar calculadora", this);
        jpCommandLeft.add(mjButtonLaunchCalc);

        moGridPayments = new DGridPaneForm(miClient, DModConsts.T_DFR, DModSysConsts.TX_DFR_CRP_PAY, "Pagos") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(false, false, false);
            }

            @Override
            public void createGridColumns() {
                int col = 0;
                DGridColumnForm[] columns = new DGridColumnForm[11];

                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DATE_DATETIME, "Fecha pago");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_CODE_CAT, "Forma pago");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DEC_AMT, "Monto pago $");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_CODE_CUR, "Moneda");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DEC_EXC_RATE, "T. cambio");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "# Operación");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "RFC emisor CB");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "# Cta. Beneficiario");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "RFC emisor CO");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "# Cta. Ordenante");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_S, "Nombre emisor CO");

                for (col = 0; col < columns.length; col++) {
                    moModel.getGridColumns().add(columns[col]);
                }
            }
        };

        moGridPaymentDocs = new DGridPaneForm(miClient, DModConsts.T_DFR, DModSysConsts.TX_DFR_CRP_PAY_DOC, "Documentos relacionados") {
            @Override
            public void initGrid() {
                setRowButtonsEnabled(false, false, false);
            }

            @Override
            public void createGridColumns() {
                int col = 0;
                DGridColumnForm[] columns = new DGridColumnForm[9];

                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_CODE_CAT, "Serie DR");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_CODE_CAT, "Folio DR");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_NAME_CAT_M, "UUID DR");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DEC_AMT, "Importe pagado $");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DEC_AMT, "Saldo anterior $");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DEC_AMT, "Saldo insoluto $");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_TEXT_CODE_CUR, "Moneda DR");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_INT_2B, "Parcialidad DR");
                columns[col++] = new DGridColumnForm(DGridConsts.COL_TYPE_DEC_EXC_RATE, "T. cambio");

                for (col = 0; col < columns.length; col++) {
                    moModel.getGridColumns().add(columns[col]);
                }
            }
        };

        moGridPayments.setForm(null);
        moGridPaymentDocs.setForm(null);

        jpPayments.add(moGridPayments, BorderLayout.CENTER);
        jpPaymentDocs.add(moGridPaymentDocs, BorderLayout.CENTER);

        mvFormGrids.add(moGridPayments);
        mvFormGrids.add(moGridPaymentDocs);
    }

    private void freeLockByCancel() {
        if (moRegistryLock != null) {
            try {
                DLockUtils.freeLock(miClient.getSession(), moRegistryLock, DDbLock.LOCK_ST_FREED_CANCEL);
            }
            catch (Exception e) {
                DLibUtils.showException(this, e);
            }
            finally {
                moRegistryLock = null;
            }
        }
    }
    
    private Date composePayDatetime() throws Exception {
        return DLibUtils.DateFormatDatetime.parse(DLibUtils.DateFormatDate.format(moDatePayDate.getValue()) + " " + moTextPayTime.getValue());
    }
    
    private void initFieldsPayment() {
        moDatePayDate.setValue(miClient.getSession().getWorkingDate());
        moTextPayTime.setValue("12:00:00");
        
        if (moKeyReceiver.getSelectedIndex() > 0) {
            String mop = moXmlCatalogModeOfPayment.getCode(moBizPartnerConfig.getActualFkModeOfPaymentTypeId());
            if (mop.equals(DCfdi40Catalogs.FDP_POR_DEF)) {
                moKeyPayModeOfPaymentType.resetField();
            }
            else {
                moKeyPayModeOfPaymentType.setValue(new int[] { moBizPartnerConfig.getActualFkModeOfPaymentTypeId() });
            }
            moKeyPayCurrency.setValue(new int[] { moBizPartnerConfig.getActualFkCurrencyId(miClient.getSession()) });
        }
    }
    
    private void enabledFieldsDfr() {
        boolean enable = moRegistry.getFkXmlStatusId() <= DModSysConsts.TS_XML_ST_ISS && moGridPayments.getTable().getRowCount() == 0;
        
        moKeyReceiver.setEnabled(enable);
        jbReceiverPick.setEnabled(enable);
        jbReceiverEdit.setEnabled(enable);
        moKeyDfrReceiverTaxRegime.setEnabled(enable);
        moKeyDfrCfdUsage.setEnabled(enable);
        moDateDate.setEditable(enable);
        moTextDfrConfirmation.setEditable(enable);
        moKeyDfrIssuerTaxRegime.setEnabled(enable);
        moRadModeEmit.setEnabled(enable);
        moRadModeEmitPay.setEnabled(enable);
        jbDfrCfdRelationsEdit.setEnabled(enable);
    }
    
    private void enableFieldsPayments(final boolean enable) {
        moDatePayDate.setEditable(enable);
        moTextPayTime.setEditable(enable);
        moKeyPayModeOfPaymentType.setEnabled(enable);
        moKeyPayCurrency.setEnabled(enable);
        boolean enableXrt = enable && moKeyPayCurrency.getSelectedIndex() > 0 && !miClient.getSession().getSessionCustom().isLocalCurrency(new int[] { moXmlCatalogCurrency.getId(moKeyPayCurrency.getSelectedItem().getCode()) });
        moDecPayExchangeRate.setEnabled(enableXrt); // enable or disable
        jbPayExchangeRatePick.setEnabled(/*enableXrt*/false); // should be enabled when needed, but until implemented!
        moCurPayAmountPay.getField().setEditable(enable);
        moTextPayOperation.setEditable(enable);
        moTextPayPayersBank.setEditable(enable);
        moTextPayPayersBankFiscalId.setEditable(enable);
        moTextPayPayersAccount.setEditable(enable);
        moTextPayRecipientsBankFiscalId.setEditable(enable);
        moTextPayRecipientsAccount.setEditable(enable);
    }
    
    private void enableFieldsPaymentDocs(final boolean enable) {
        moTextDocSeries.setEditable(enable);
        moIntDocNumber.setEditable(enable);
        moTextDocUuid.setEditable(enable);
        jbDocPick.setEnabled(enable);
        moKeyDocCurrency.setEnabled(enable);
        boolean enableXrt = enable && moKeyPayCurrency.getSelectedIndex() > 0 && moKeyDocCurrency.getSelectedIndex() > 0 && moKeyPayCurrency.getSelectedItem().getCode().equals(moKeyDocCurrency.getSelectedItem().getCode());
        moDecDocExchangeRate.setEnabled(enableXrt); // enable or disable
        jbDocExchangeRatePick.setEnabled(/*enableXrt*/false); // should be enabled when needed, but until implemented!
        jbDocExchangeRateInvert.setEnabled(enableXrt);
        moIntDocInstallment.setEditable(enable);
        moCurDocBalancePrevDoc.getField().setEditable(enable);
        moCurDocPaymentDoc.getField().setEditable(enable);
    }
    
    private void enableButtonsPaymentsEdition(final boolean enable) {
        jbPayAdd.setEnabled(enable);
        jbPayModify.setEnabled(enable);
        jbPayDelete.setEnabled(enable);
    }
    
    private void enableButtonsPaymentsOkCancel(final boolean enable) {
        jbPayOk.setEnabled(enable);
        jbPayCancel.setEnabled(enable);
    }
    
    private void enableButtonsPaymentDocsEdition(final boolean enable) {
        jbDocAdd.setEnabled(enable);
        jbDocModify.setEnabled(enable);
        jbDocDelete.setEnabled(enable);
    }
    
    private void enableButtonsPaymentDocsOkCancel(final boolean enable) {
        jbDocOk.setEnabled(enable);
        jbDocCancel.setEnabled(enable);
    }
    
    private boolean validateFieldsCfd() {
        ArrayList<DGuiField> fields = new ArrayList<>();
        fields.add(moKeyReceiver);
        fields.add(moKeyDfrReceiverTaxRegime);
        fields.add(moKeyDfrCfdUsage);
        fields.add(moTextSeries);
        fields.add(moIntNumber);
        fields.add(moDateDate);
        fields.add(moKeyDummyCurrency);
        fields.add(moDecDummyExchangeRate);
        fields.add(moTextDfrConfirmation);
        fields.add(moKeyDfrIssuerTaxRegime);
        
        DGuiValidation validation;
        for (DGuiField field : fields) {
            validation = field.validateField();
            if (!validation.isValid()) {
                DGuiUtils.computeValidation(miClient, validation);
                return false;
            }
        }
        
        return true;
    }

    private boolean validateFieldsPayments() {
        ArrayList<DGuiField> fields = new ArrayList<>();
        fields.add(moDatePayDate);
        fields.add(moTextPayTime);
        fields.add(moKeyPayModeOfPaymentType);
        fields.add(moKeyPayCurrency);
        fields.add(moDecPayExchangeRate);
        fields.add(moCurPayAmountPay.getField());
        fields.add(moTextPayOperation);
        fields.add(moTextPayPayersBank);
        fields.add(moTextPayPayersBankFiscalId);
        fields.add(moTextPayPayersAccount);
        fields.add(moTextPayRecipientsBankFiscalId);
        fields.add(moTextPayRecipientsAccount);
        
        DGuiValidation validation = null;
        for (DGuiField field : fields) {
            validation = field.validateField();
            if (!validation.isValid()) {
                break;
            }
        }
        
        if (validation != null) {
            if (validation.isValid()) {
                if (moKeyPayModeOfPaymentType.getSelectedItem().getCode().equals(DCfdi40Catalogs.FDP_POR_DEF)) {
                    validation.setMessage(DGuiConsts.ERR_MSG_FIELD_DIF + "'" + moKeyPayModeOfPaymentType.getFieldName() + "'.");
                    validation.setComponent(moKeyPayModeOfPaymentType);
                }
            }
            
            if (!validation.isValid()) {
                DGuiUtils.computeValidation(miClient, validation);
                return false;
            }
        }
        
        try {
            composePayDatetime();
        }
        catch (Exception e) {
            DLibUtils.showException(this, e);
            return false;
        }
        
        return true;
    }

    private boolean validateFieldsPaymentDocs() {
        ArrayList<DGuiField> fields = new ArrayList<>();
        fields.add(moTextDocSeries);
        fields.add(moIntDocNumber);
        fields.add(moTextDocUuid);
        fields.add(moKeyDocCurrency);
        fields.add(moDecDocExchangeRate);
        fields.add(moIntDocInstallment);
        fields.add(moCurDocBalancePrevDoc.getField());
        fields.add(moCurDocPaymentDoc.getField());
        
        DGuiValidation validation;
        for (DGuiField field : fields) {
            validation = field.validateField();
            if (!validation.isValid() && field.isEnabled()) {
                DGuiUtils.computeValidation(miClient, validation);
                return false;
            }
        }
        
        if (moDoc != null) {
            validation = new DGuiValidation();
            if (!moTextDocSeries.getValue().equals(moDoc.getSeries())) {
                validation.setMessage(DGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + moTextDocSeries.getFieldName() + "'" + DGuiConsts.ERR_MSG_FIELD_VAL_EQUAL + "'" + moDoc.getSeries() + "'");
                validation.setComponent(moTextDocSeries);
            }
            else if (moIntDocNumber.getValue() != moDoc.getNumber()) {
                validation.setMessage(DGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + moIntDocNumber.getFieldName() + "'" + DGuiConsts.ERR_MSG_FIELD_VAL_EQUAL + "'" + moDoc.getNumber()+ "'");
                validation.setComponent(moIntDocNumber);
            }
            else if (moDoc.getChildDfr() != null && !moTextDocUuid.getValue().equals(moDoc.getChildDfr().getUuid())) {
                validation.setMessage(DGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + moTextDocUuid.getFieldName() + "'" + DGuiConsts.ERR_MSG_FIELD_VAL_EQUAL + "'" + moDoc.getChildDfr().getUuid()+ "'");
                validation.setComponent(moTextDocUuid);
            }
            else if (moKeyDocCurrency.getValue()[0] != moDoc.getFkCurrencyId()) {
                validation.setMessage(DGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + moKeyDocCurrency.getFieldName() + "'" + DGuiConsts.ERR_MSG_FIELD_VAL_EQUAL + "'" + miClient.getSession().getSessionCustom().getCurrency(new int[] { moDoc.getFkCurrencyId() }) + "'");
                validation.setComponent(moKeyDocCurrency);
            }
            
            if (!validation.isValid()) {
                DGuiUtils.computeValidation(miClient, validation);
                return false;
            }
        }
        
        return true;
    }
    
    private void renderPayment(final DGridRow row) {
        mdDocTotalPayment = 0;
        Vector<DGridRow> paymentDocs = new Vector<>();
        
        if (row == null) {
            moDatePayDate.resetField();
            moTextPayTime.resetField();
            moKeyPayModeOfPaymentType.resetField();
            moKeyPayCurrency.resetField();
            moDecPayExchangeRate.resetField();
            moCurPayAmountPay.getField().resetField();
            moTextPayOperation.resetField();
            moTextPayPayersBank.resetField();
            moTextPayPayersBankFiscalId.resetField();
            moTextPayPayersAccount.resetField();
            moTextPayRecipientsBankFiscalId.resetField();
            moTextPayRecipientsAccount.resetField();
        }
        else {
            DElementPagosPago pago = ((DRowDfrPayment) row).getPago();
            moDatePayDate.setValue(pago.getAttFechaPago().getDatetime());
            moTextPayTime.setValue(DLibUtils.DateFormatTime.format(pago.getAttFechaPago().getDatetime()));
            moKeyPayModeOfPaymentType.setValue(new int[] { moXmlCatalogModeOfPayment.getId(pago.getAttFormaDePagoP().getString()) });
            moKeyPayCurrency.setValue(new int[] { moXmlCatalogCurrency.getId(pago.getAttMonedaP().getString()) });
            double xrt = pago.getAttTipoCambioP().getDouble();
            moDecPayExchangeRate.setValue(xrt == 0 ? 1d : xrt);
            moCurPayAmountPay.getField().setValue(pago.getAttMonto().getDouble());
            moTextPayOperation.setValue(pago.getAttNumOperacion().getString());
            moTextPayPayersBank.setValue(pago.getAttNomBancoOrdExt().getString());
            moTextPayPayersBankFiscalId.setValue(pago.getAttRfcEmisorCtaOrd().getString());
            moTextPayPayersAccount.setValue(pago.getAttCtaOrdenante().getString());
            moTextPayRecipientsBankFiscalId.setValue(pago.getAttRfcEmisorCtaBen().getString());
            moTextPayRecipientsAccount.setValue(pago.getAttCtaBeneficiario().getString());
            
            for (DElementDoctoRelacionado doctoRelacionado : pago.getEltDoctoRelacionados()) {
                double xrtDoc = doctoRelacionado.getAttTipoCambioDR().getDouble(); // 0 means that currency of payment and payed document is the same

                mdDocTotalPayment = DLibUtils.roundAmount(mdDocTotalPayment + 
                        (doctoRelacionado.getAttImpPagado().getDouble() / (xrtDoc == 0 ? 1d : xrtDoc)));
                paymentDocs.add(new DRowDfrPaymentDoc(doctoRelacionado));
            }
        }
        
        moGridPaymentDocs.populateGrid(paymentDocs, this);
        if (paymentDocs.isEmpty()) {
            renderPaymentDoc(null);
        }
        
        computeTotalPayment();
    }
    
    private void renderPaymentDoc(final DGridRow row) {
        if (row == null) {
            moTextDocSeries.resetField();
            moIntDocNumber.resetField();
            moTextDocUuid.resetField();
            moKeyDocCurrency.resetField();
            moDecDocExchangeRate.resetField();
            moIntDocInstallment.resetField();
            moCurDocBalancePrevDoc.getField().resetField();
            moCurDocPaymentDoc.getField().resetField();
            moCurDocBalancePendDoc.getField().resetField();
            
            moDoc = null;
        }
        else {
            DElementDoctoRelacionado doctoRelacionado = ((DRowDfrPaymentDoc) row).getDoctoRelacionado();
            moTextDocSeries.setValue(doctoRelacionado.getAttSerie().getString());
            moIntDocNumber.setValue(DLibUtils.parseInt(doctoRelacionado.getAttFolio().getString()));
            moTextDocUuid.setValue(doctoRelacionado.getAttIdDocumento().getString());
            moKeyDocCurrency.setValue(new int[] { moXmlCatalogCurrency.getId(doctoRelacionado.getAttMonedaDR().getString()) });
            double xrt = doctoRelacionado.getAttTipoCambioDR().getDouble();
            moDecDocExchangeRate.setValue(xrt == 0 ? 1 : xrt);
            moIntDocInstallment.setValue(doctoRelacionado.getAttNumParcialidad().getInteger());
            moCurDocBalancePrevDoc.getField().setValue(doctoRelacionado.getAttImpSaldoAnt().getDouble());
            moCurDocPaymentDoc.getField().setValue(doctoRelacionado.getAttImpPagado().getDouble());
            moCurDocBalancePendDoc.getField().setValue(doctoRelacionado.getAttImpSaldoInsoluto().getDouble());
            
            try {
                moDoc = DTrnUtils.getDpsByUuid(miClient.getSession(), moTextDocUuid.getText());
            }
            catch (Exception e) {
                // do not show exception, maybe CFDI belogs to thir parties
            }
        }
    }
    
    private void renderDoc() {
        if (moDoc == null) {
            moTextDocSeries.resetField();
            moIntDocNumber.resetField();
            moTextDocUuid.resetField();
            moKeyDocCurrency.resetField();
            moIntDocInstallment.resetField();
            moCurDocBalancePrevDoc.getField().resetField();
            moCurDocPaymentDoc.getField().resetField();
        }
        else {
            moTextDocSeries.setValue(moDoc.getSeries());
            moIntDocNumber.setValue(moDoc.getNumber());
            moTextDocUuid.setValue(moDoc.getChildDfr() == null ? "" : moDoc.getChildDfr().getUuid());
            moKeyDocCurrency.setValue(new int[] { moDoc.getFkCurrencyId() });
            
            int installment = 0;
            try {
                installment = DTrnUtils.getDpsPaymentsCount(miClient.getSession(), DModSysConsts.BS_BPR_CL_CUS, moDoc.getPkDpsId(), moRegistry.getBookkeepingNumberKey_n());
            }
            catch (Exception e) {
                DLibUtils.showException(this, e);
            }
            moIntDocInstallment.setValue(installment + 1);
            
            DTrnAmount amount = DTrnUtils.getBalanceForDps(miClient.getSession(), miClient.getSession().getSystemYear(), moDoc.getPrimaryKey());
            moCurDocBalancePrevDoc.getField().setValue(amount.getAmountCy());
            
            if (DLibUtils.compareKeys(moKeyPayCurrency.getValue(), moKeyDocCurrency.getValue())) {
                double remanent = moCurPayAmountPay.getField().getValue() - mdDocTotalPayment;
                moCurDocPaymentDoc.getField().setValue(remanent <= 0 ? 0 : (remanent > amount.getAmountCy() ? amount.getAmountCy() : remanent));
            }
            else {
                moCurDocPaymentDoc.getField().setValue(0d);
            }
        }
        
        computePaymentDocPend();
    }
    
    private void activateInputPayment(int mode) {
        mnModePayment = mode;
        
        switch (mnModePayment) {
            case 0:
                enableFieldsPayments(false);
                enableButtonsPaymentsEdition(true);
                enableButtonsPaymentsOkCancel(false);
                moGridPayments.getTable().setEnabled(true);

                enableButtonsPaymentDocsEdition(true);
                moGridPaymentDocs.getTable().setEnabled(true);

                jbPayAdd.requestFocusInWindow();
                break;
                
            case MODE_ADD:
            case MODE_MODIFY:
                enableFieldsPayments(true);
                enableButtonsPaymentsEdition(false);
                enableButtonsPaymentsOkCancel(true);
                moGridPayments.getTable().setEnabled(false);

                enableButtonsPaymentDocsEdition(false);
                moGridPaymentDocs.getTable().setEnabled(false);

                moDatePayDate.requestFocusInWindow();
                break;
                
            default:
                miClient.showMsgBoxError(DLibConsts.ERR_MSG_OPTION_UNKNOWN);
        }
    }

    private void activateInputPaymentDoc(int mode) {
        mnModePaymentDoc = mode;
        
        switch (mnModePaymentDoc) {
            case 0:
                enableButtonsPaymentsEdition(true);
                moGridPayments.getTable().setEnabled(true);

                enableFieldsPaymentDocs(false);
                enableButtonsPaymentDocsEdition(true);
                enableButtonsPaymentDocsOkCancel(false);
                moGridPaymentDocs.getTable().setEnabled(true);
                
                moDoctoRelacionado = null;

                jbDocAdd.requestFocusInWindow();
                break;
                
            case MODE_ADD:
            case MODE_MODIFY:
                enableButtonsPaymentsEdition(false);
                moGridPayments.getTable().setEnabled(false);

                enableFieldsPaymentDocs(true);
                enableButtonsPaymentDocsEdition(false);
                enableButtonsPaymentDocsOkCancel(true);
                moGridPaymentDocs.getTable().setEnabled(false);
                
                if (mnModePaymentDoc == MODE_ADD) {
                    moDoctoRelacionado = null;

                    jbDocPick.doClick();
                }
                else {
                    moDoctoRelacionado = ((DRowDfrPaymentDoc) moGridPaymentDocs.getSelectedGridRow()).getDoctoRelacionado();

                    moTextDocSeries.requestFocusInWindow();
                }
                break;
                
            default:
                miClient.showMsgBoxError(DLibConsts.ERR_MSG_OPTION_UNKNOWN);
        }
    }

    private void computeTotalCfd() {
        double paymentPay = 0; // payment currency
        double paymentLoc = 0; // local currency
        HashMap<Integer, String> currencies = new HashMap<>();
        
        for (DGridRow row : moGridPayments.getModel().getGridRows()) {
            DElementPagosPago pago = ((DRowDfrPayment) row).getPago();
            double xrt = pago.getAttTipoCambioP().getDouble(); // 0 means that currency of payment is local currency
            
            int currency = moXmlCatalogCurrency.getId(pago.getAttMonedaP().getString());
            currencies.put(currency, pago.getAttMonedaP().getString());
            
            paymentPay = DLibUtils.roundAmount(paymentPay + 
                    pago.getAttMonto().getDouble());
            paymentLoc = DLibUtils.roundAmount(paymentLoc + 
                    (miClient.getSession().getSessionCustom().isLocalCurrency(new int[] { currency }) ? pago.getAttMonto().getDouble() : DLibUtils.roundAmount(pago.getAttMonto().getDouble() * (xrt == 0d ? 1d : xrt))));
        }
        
        moCurTotalCfdLoc.getField().setValue(paymentLoc);
        
        if (currencies.size() == 1) {
            moCurTotalCfdPay.getField().setValue(paymentPay);
            moCurTotalCfdPay.setCompoundText(currencies.values().toArray()[0].toString());
        }
        else {
            moCurTotalCfdPay.getField().setValue(Double.NaN);
            moCurTotalCfdPay.setCompoundText("");
        }
    }
    
    private void computeTotalPayment() {
        mdDocTotalPayment = 0;
        double paymentLoc = 0; // local currency
        double xrtPay = 0;
        
        if (moGridPayments.getSelectedGridRow() != null) {
            xrtPay = ((DRowDfrPayment) moGridPayments.getSelectedGridRow()).getPago().getAttTipoCambioP().getDouble();
        }
        
        for (DGridRow row : moGridPaymentDocs.getModel().getGridRows()) {
            DElementDoctoRelacionado doctoRelacionado = ((DRowDfrPaymentDoc) row).getDoctoRelacionado();
            double xrtDoc = doctoRelacionado.getAttTipoCambioDR().getDouble(); // 0 means that currency of payment and payed document is the same
            
            mdDocTotalPayment = DLibUtils.roundAmount(mdDocTotalPayment + 
                    (doctoRelacionado.getAttImpPagado().getDouble() / (xrtDoc == 0 ? 1d : xrtDoc)));
            paymentLoc = DLibUtils.roundAmount(paymentLoc + 
                    (doctoRelacionado.getAttImpPagado().getDouble() / (xrtDoc == 0 ? 1d : xrtDoc)) * (xrtPay == 0d ? 1d : xrtPay));
        }
        
        moCurTotalPaymentPay.getField().setValue(mdDocTotalPayment);
        moCurTotalPaymentLoc.getField().setValue(paymentLoc);
    }
    
    /*
     * Action-performed-event handlers
     */

    private void actionPerformedReceiverPick() {
        moDialogFindBizPartner.resetForm();
        moDialogFindBizPartner.initForm();
        moDialogFindBizPartner.setVisible(true);

        if (moDialogFindBizPartner.getFormResult() == DGuiConsts.FORM_RESULT_OK) {
            if (moDialogFindBizPartner.getNewRegistries()) {
                miClient.getSession().populateCatalogue(moKeyReceiver, DModConsts.BU_BPR, DModSysConsts.BS_BPR_CL_CUS, null);
            }
            moKeyReceiver.setValue(moDialogFindBizPartner.getValue(DModConsts.BU_BPR));
            moKeyReceiver.requestFocus();
        }
    }

    private void actionPerformedReceiverEdit() {
        if (jbReceiverEdit.isEnabled()) {
            if (moKeyReceiver.getSelectedIndex() <= 0) {
                miClient.showMsgBoxInformation(DGuiConsts.MSG_GUI_SELECT_OPTION);
            }
            else {
                int[] key = moKeyReceiver.getValue();
                miClient.getSession().showForm(DModConsts.BU_BPR, DModSysConsts.BS_BPR_CL_CUS, new DGuiParams(key));

                // XXX Improve this: form must be updated unless user select "Ok" when closing business partner form.
                miClient.getSession().populateCatalogue(moKeyReceiver, DModConsts.BU_BPR, DModSysConsts.BS_BPR_CL_CUS, null);
                moKeyReceiver.setValue(key);
                moKeyReceiver.requestFocus();
            }
        }
    }

    private void actionPerformedDfrExchangeRatePick() {
        miClient.showMsgBoxInformation("Favor de captuar manualmente el tipo de cambio deseado.");
        moDecDummyExchangeRate.requestFocusInWindow();
    }
    
    private void actionPerformedDfrCfdRelationsEdit() {
        try {
            moDialogCfdRelations.resetForm();
            moDialogCfdRelations.setValue(DModConsts.TX_DFR_RELATIONS, moRegistry.getXtaDfr().getCfdRelations());
            moDialogCfdRelations.setValue(DGuiConsts.PARAM_STATUS, jbSave.isEnabled() ? DGuiConsts.FORM_STATUS_EDIT : DGuiConsts.FORM_STATUS_READ);
            moDialogCfdRelations.setVisible(true);
            
            if (moDialogCfdRelations.getFormResult() == DGuiConsts.FORM_RESULT_OK) {
                moRegistry.getXtaDfr().setCfdRelations((DDfrCfdRelations) moDialogCfdRelations.getValue(DModConsts.TX_DFR_RELATIONS));
                jtfDfrCfdRelations.setText(moRegistry.getXtaDfr().getCfdRelations() == null ? "" : moRegistry.getXtaDfr().getCfdRelations().toString());
                jtfDfrCfdRelations.setCaretPosition(0);
            }
        }
        catch (Exception e) {
            DLibUtils.showException(this, e);
        }
    }

    private void actionPerformedPayExchangeRatePick() {
        miClient.showMsgBoxInformation("Favor de captuar manualmente el tipo de cambio deseado.");
        moDecPayExchangeRate.requestFocusInWindow();
    }
    
    private void actionPerformedPayAdd() {
        renderPayment(null);
        initFieldsPayment();
        activateInputPayment(MODE_ADD);
    }

    private void actionPerformedPayModify() {
        if (moGridPayments.getSelectedGridRow() == null) {
            miClient.showMsgBoxWarning(DGridConsts.MSG_SELECT_ROW);
        }
        else {
            activateInputPayment(MODE_MODIFY);
        }
    }

    private void actionPerformedPayDelete() {
        if (moGridPayments.getSelectedGridRow() == null) {
            miClient.showMsgBoxWarning(DGridConsts.MSG_SELECT_ROW);
        }
        else if (miClient.showMsgBoxConfirm(DGridConsts.MSG_CONFIRM_REG_DEL) == JOptionPane.YES_OPTION) {
            // update form grid:
            int index = moGridPayments.getTable().getSelectedRow();
            moGridPayments.removeGridRow(index);
            moGridPayments.renderGridRows();
            moGridPayments.setSelectedGridRow(index < moGridPayments.getTable().getRowCount() ? index : index - 1);
            
            // update GUI totals:
            computeTotalCfd();
            
            // update GUI:
            enabledFieldsDfr();
        }
    }

    private void actionPerformedPayOk() {
        if (validateFieldsCfd() && validateFieldsPayments()) {
            Date payDatetime = null;
            try {
                payDatetime = composePayDatetime();
            }
            catch (Exception e) {
                // no exception should be thrown!
            }
            
            DElementPagosPago pago = new DElementPagosPago();
            pago.getAttFechaPago().setDatetime(payDatetime);
            pago.getAttFormaDePagoP().setString(moKeyPayModeOfPaymentType.getSelectedItem().getCode());
            pago.getAttMonedaP().setString(moKeyPayCurrency.getSelectedItem().getCode());
            pago.getAttTipoCambioP().setDouble(miClient.getSession().getSessionCustom().isLocalCurrency(moKeyPayCurrency.getValue()) ? 0d : moDecPayExchangeRate.getValue());
            pago.getAttMonto().setDouble(moCurPayAmountPay.getField().getValue());
            pago.getAttNumOperacion().setString(moTextPayOperation.getValue());
            pago.getAttRfcEmisorCtaOrd().setString(moTextPayPayersBankFiscalId.getValue());
            pago.getAttNomBancoOrdExt().setString(moTextPayPayersBank.getValue());
            pago.getAttCtaOrdenante().setString(moTextPayPayersAccount.getValue());
            pago.getAttRfcEmisorCtaBen().setString(moTextPayRecipientsBankFiscalId.getValue());
            pago.getAttCtaBeneficiario().setString(moTextPayRecipientsAccount.getValue());
            //pago.getAttTipoCadPago().setString(...);
            //pago.getAttCertPago().setString(...);
            //pago.getAttCadPago().setString(...);
            //pago.getAttSelloPago().setString(...);
            
            DRowDfrPayment row = new DRowDfrPayment(pago);
            
            // update form grid:
            switch (mnModePayment) {
                case MODE_ADD:
                    moGridPayments.addGridRow(row);
                    moGridPayments.renderGridRows();
                    moGridPayments.setSelectedGridRow(moGridPayments.getTable().getRowCount() - 1);
                    break;
                    
                case MODE_MODIFY:
                    int index = moGridPayments.getTable().getSelectedRow();
                    moGridPayments.setGridRow(row, index);
                    moGridPayments.renderGridRows();
                    moGridPayments.setSelectedGridRow(index);
                    break;
                    
                default:
                    miClient.showMsgBoxError(DLibConsts.ERR_MSG_OPTION_UNKNOWN);
            }
            
            // update GUI totals:
            computeTotalCfd();
            
            // update GUI:
            activateInputPayment(0);
            enabledFieldsDfr();
            jbDocAdd.requestFocusInWindow();
        }
    }

    private void actionPerformedPayCancel() {
        renderPayment(moGridPayments.getSelectedGridRow());
        activateInputPayment(0);
    }

    private void actionPerformedDocPick() {
        moDialogDpsInvoicePicker.resetForm();
        moDialogDpsInvoicePicker.setValue(DModConsts.BU_BPR, moBizPartner.getPkBizPartnerId());
        moDialogDpsInvoicePicker.setVisible(true);
        if (moDialogDpsInvoicePicker.getFormResult() == DGuiConsts.FORM_RESULT_OK) {
            try {
                moDoc = moDialogDpsInvoicePicker.getRegistry();
                renderDoc();
                moIntDocInstallment.requestFocusInWindow();
            }
            catch (Exception e) {
                DLibUtils.showException(this, e);
            }
        }
    }

    private void actionPerformedDocExchangeRatePick() {
        miClient.showMsgBoxInformation("Favor de captuar manualmente el tipo de cambio deseado.");
        moDecDocExchangeRate.requestFocusInWindow();
    }

    private void actionPerformedDocExchangeRateInvert() {
        moDecDocExchangeRate.setValue(moDecDocExchangeRate.getValue() == 0 ? 0 : 1d / moDecDocExchangeRate.getValue());
        moDecDocExchangeRate.requestFocusInWindow();
    }
    
    private void actionPerformedDocAdd() {
        renderPaymentDoc(null);
        activateInputPaymentDoc(MODE_ADD);
    }

    private void actionPerformedDocModify() {
        if (moGridPaymentDocs.getSelectedGridRow() == null) {
            miClient.showMsgBoxWarning(DGridConsts.MSG_SELECT_ROW);
        }
        else {
            activateInputPaymentDoc(MODE_MODIFY);
        }
    }

    private void actionPerformedDocDelete() {
        if (moGridPaymentDocs.getSelectedGridRow() == null) {
            miClient.showMsgBoxWarning(DGridConsts.MSG_SELECT_ROW);
        }
        else if (miClient.showMsgBoxConfirm(DGridConsts.MSG_CONFIRM_REG_DEL) == JOptionPane.YES_OPTION) {
            // update form grid:
            int index = moGridPaymentDocs.getTable().getSelectedRow();
            DGridRow removedRow = moGridPaymentDocs.removeGridRow(index);
            moGridPaymentDocs.renderGridRows();
            moGridPaymentDocs.setSelectedGridRow(index < moGridPaymentDocs.getTable().getRowCount() ? index : index - 1);
            
            // update array of DoctoRelacionados of current payment:
            ((DRowDfrPayment) moGridPayments.getSelectedGridRow()).getPago().getEltDoctoRelacionados().remove(((DRowDfrPaymentDoc) removedRow).getDoctoRelacionado());
            
            // update GUI totals:
            computeTotalPayment();
        }
    }

    private void actionPerformedDocOk() {
        if (validateFieldsPaymentDocs()) {
            DElementDoctoRelacionado doctoRelacionado = new DElementDoctoRelacionado();
            
            doctoRelacionado.getAttIdDocumento().setString(moTextDocUuid.getValue());
            doctoRelacionado.getAttSerie().setString(moTextDocSeries.getValue());
            doctoRelacionado.getAttFolio().setString(moIntDocNumber.getValue().toString());
            doctoRelacionado.getAttMonedaDR().setString(moKeyDocCurrency.getSelectedItem().getCode());
            doctoRelacionado.getAttTipoCambioDR().setDouble(miClient.getSession().getSessionCustom().isLocalCurrency(moKeyDocCurrency.getValue()) ? 0d : moDecDocExchangeRate.getValue());
            doctoRelacionado.getAttMetodoDePagoDR().setString(DCfdi40Catalogs.MDP_PPD);
            doctoRelacionado.getAttNumParcialidad().setInteger(moIntDocInstallment.getValue());
            doctoRelacionado.getAttImpSaldoAnt().setDouble(moCurDocBalancePrevDoc.getField().getValue());
            doctoRelacionado.getAttImpPagado().setDouble(moCurDocPaymentDoc.getField().getValue());
            doctoRelacionado.getAttImpSaldoInsoluto().setDouble(moCurDocBalancePendDoc.getField().getValue());
            
            DRowDfrPaymentDoc row = new DRowDfrPaymentDoc(doctoRelacionado);
            
            // update form grid:
            switch (mnModePaymentDoc) {
                case MODE_ADD:
                    moGridPaymentDocs.addGridRow(row);
                    moGridPaymentDocs.renderGridRows();
                    moGridPaymentDocs.setSelectedGridRow(moGridPaymentDocs.getTable().getRowCount() - 1);
                    
                    // update array of DoctoRelacionados of current payment:
                    ((DRowDfrPayment) moGridPayments.getSelectedGridRow()).getPago().getEltDoctoRelacionados().add(doctoRelacionado);
                    break;
                    
                case MODE_MODIFY:
                    int index = moGridPaymentDocs.getTable().getSelectedRow();
                    moGridPaymentDocs.setGridRow(row, index);
                    moGridPaymentDocs.renderGridRows();
                    moGridPaymentDocs.setSelectedGridRow(index);
                    
                    // update array of DoctoRelacionados of current payment:
                    int indexToReplace = ((DRowDfrPayment) moGridPayments.getSelectedGridRow()).getPago().getEltDoctoRelacionados().indexOf(moDoctoRelacionado);
                    ((DRowDfrPayment) moGridPayments.getSelectedGridRow()).getPago().getEltDoctoRelacionados().set(indexToReplace, doctoRelacionado);
                    break;
                    
                default:
                    miClient.showMsgBoxError(DLibConsts.ERR_MSG_OPTION_UNKNOWN);
            }
            
            // update GUI totals:
            computeTotalPayment();
            
            // update GUI:
            activateInputPaymentDoc(0);
        }
    }

    private void actionPerformedDocCancel() {
        renderPaymentDoc(moGridPaymentDocs.getSelectedGridRow());
        activateInputPaymentDoc(0);
    }

    private void actionPerformedLaunchCalc() {
        DLibUtils.launchCalculator();
    }

    /*
     * Focus-event handlers
     */

    private void focusLostDocUuid() {
        if (moTextDocUuid.getText().length() == DCfdVer4Consts.LEN_UUID) {
            try {
                moDoc = DTrnUtils.getDpsByUuid(miClient.getSession(), moTextDocUuid.getText());
                renderDoc();
            }
            catch (Exception e) {
                DLibUtils.showException(this, e);
            }
        }
    }
    
    private void computePayment() {
        moCurPayAmountLoc.getField().setValue(DLibUtils.roundAmount(moCurPayAmountPay.getField().getValue() * moDecPayExchangeRate.getValue()));
    }
    
    private void computePaymentDoc() {
        if (moDecDocExchangeRate.getValue() == 0) {
            moCurDocBalancePendPay.getField().setValue(0d);
            moCurDocPaymentPay.getField().setValue(0d);
            moCurDocBalancePrevPay.getField().setValue(0d);
        }
        else {
            moCurDocBalancePendPay.getField().setValue(DLibUtils.roundAmount(moCurDocBalancePendDoc.getField().getValue() / moDecDocExchangeRate.getValue()));
            moCurDocPaymentPay.getField().setValue(DLibUtils.roundAmount(moCurDocPaymentDoc.getField().getValue() / moDecDocExchangeRate.getValue()));
            moCurDocBalancePrevPay.getField().setValue(DLibUtils.roundAmount(moCurDocBalancePrevDoc.getField().getValue() / moDecDocExchangeRate.getValue()));
        }
    }
    
    private void computePaymentDocPend() {
        moCurDocBalancePendDoc.getField().setValue(DLibUtils.roundAmount(moCurDocBalancePrevDoc.getField().getValue() - moCurDocPaymentDoc.getField().getValue()));
        computePaymentDoc();
    }
    
    /*
     * Item-state-changed-event handlers
     */
    
    private void itemStateChangedCfdReceiver() {
        if (moKeyReceiver.getSelectedIndex() <= 0) {
            moBizPartner = null;
            moBizPartnerConfig = null;
            moBizPartnerBranchHeadquarters = null;
            moBizPartnerBranchAddressOfficial = null;
            mnBizPartnerIdentityType = ((DGuiClientSessionCustom) miClient.getSession().getSessionCustom()).getIdentityTypeDefault();
            moKeyDfrReceiverTaxRegime.removeAllItems();

            jtfDfrReceiverFiscalId.setEnabled(false);
            jtfDfrReceiverFiscalAddress.setEnabled(false);
            moKeyDfrReceiverTaxRegime.setEnabled(false);
            moKeyDfrCfdUsage.setEnabled(false);
            moKeyDummyCurrency.setEnabled(false);
            moDecDummyExchangeRate.setEnabled(false);
        
            moRadModeEmit.setEnabled(false);
            moRadModeEmitPay.setEnabled(false);
            
            jtfDfrReceiverFiscalId.setText("");
            jtfDfrReceiverFiscalAddress.setText("");
            moKeyDfrReceiverTaxRegime.resetField();
            moKeyDfrCfdUsage.resetField();
            moKeyDummyCurrency.resetField();
            moDecDummyExchangeRate.resetField();
        
            bgMode.clearSelection();
            
            enableFieldsPayments(false);
            enableButtonsPaymentsEdition(false);
            enableButtonsPaymentsOkCancel(false);
        }
        else {
            moBizPartner = (DDbBizPartner) miClient.getSession().readRegistry(DModConsts.BU_BPR, moKeyReceiver.getValue());
            moBizPartnerConfig = moBizPartner.getChildConfig(DModSysConsts.BS_BPR_CL_CUS);
            moBizPartnerBranchHeadquarters = moBizPartner.getChildBranchHeadquarters();
            moBizPartnerBranchAddressOfficial = moBizPartnerBranchHeadquarters.getChildAddressOfficial();
            mnBizPartnerIdentityType = moBizPartner.getFkIdentityTypeId();
            miClient.getSession().populateCatalogue(moKeyDfrReceiverTaxRegime, DModConsts.CS_TAX_REG, mnBizPartnerIdentityType, null);

            jtfDfrReceiverFiscalId.setEnabled(true);
            jtfDfrReceiverFiscalAddress.setEnabled(true);
            moKeyDfrReceiverTaxRegime.setEnabled(true);
            moKeyDfrCfdUsage.setEnabled(false); // non editable
            moKeyDummyCurrency.setEnabled(false); // not required, preserved for consistence
            moDecDummyExchangeRate.setEnabled(false); // not required, preserved for consistence
        
            moRadModeEmit.setEnabled(true);
            moRadModeEmitPay.setEnabled(true);
            
            jtfDfrReceiverFiscalId.setText(moBizPartner.getFiscalId());
            jtfDfrReceiverFiscalId.setCaretPosition(0);
            jtfDfrReceiverFiscalAddress.setText(moBizPartnerBranchAddressOfficial.getZipCode());
            jtfDfrReceiverFiscalAddress.setCaretPosition(0);
            moKeyDfrReceiverTaxRegime.setValue(new int[] { !moKeyDfrReceiverTaxRegime.isEnabled() ? 0 : moBizPartner.getFkTaxRegimeId() });
            moKeyDfrCfdUsage.setValue(new int[] { moXmlCatalogCfdUsage.getId(DCfdi40Catalogs.ClaveUsoCfdiPagos) });
            moKeyDummyCurrency.setValue(new int[] { moXmlCatalogCurrency.getId(DCfdi40Catalogs.ClaveMonedaXxx) });
            moDecDummyExchangeRate.setValue(1.0);
        
            moRadModeEmit.setSelected(true);
            
            enableFieldsPayments(false);
            enableButtonsPaymentsEdition(true);
            enableButtonsPaymentsOkCancel(false);
        }
        
        enableFieldsPaymentDocs(false);
        enableButtonsPaymentDocsEdition(false);
        enableButtonsPaymentDocsOkCancel(false);
        
        renderPayment(null);
    }

    private void itemStateChangedPayCurrency() {
        String codePay;
        
        if (moKeyPayCurrency.getSelectedIndex() <= 0) {
            codePay = "";
            
            moDecPayExchangeRate.resetField();
            moDecPayExchangeRate.setEnabled(false);
            jbPayExchangeRatePick.setEnabled(false);
        }
        else {
            codePay = moKeyPayCurrency.getSelectedItem().getCode();
            
            if (miClient.getSession().getSessionCustom().isLocalCurrency(new int[] { moXmlCatalogCurrency.getId(codePay) })) {
                moDecPayExchangeRate.setValue(1d);
                moDecPayExchangeRate.setEnabled(false);
                jbPayExchangeRatePick.setEnabled(false);
            }
            else {
                moDecPayExchangeRate.resetField();
                moDecPayExchangeRate.setEnabled(mnModePayment != 0);
                jbPayExchangeRatePick.setEnabled(/*mnModePayment != 0*/false); // should be enabled when needed, but until implemented!
            }
        }
        
        moCurPayAmountPay.setCompoundText(codePay);
        
        moCurDocBalancePrevPay.setCompoundText(codePay);
        moCurDocPaymentPay.setCompoundText(codePay);
        moCurDocBalancePendPay.setCompoundText(codePay);
        
        moCurTotalPaymentPay.setCompoundText(codePay);
        
        computePayment();
    }

    private void itemStateChangedDocCurrency() {
        String codeDoc;
        
        if (moKeyDocCurrency.getSelectedIndex() <= 0) {
            codeDoc = "";
            
            moDecDocExchangeRate.resetField();
            moDecDocExchangeRate.setEnabled(false);
            jbDocExchangeRatePick.setEnabled(false);
            jbDocExchangeRateInvert.setEnabled(false);
        }
        else {
            String codePay = moKeyPayCurrency.getSelectedItem().getCode();
            codeDoc = moKeyDocCurrency.getSelectedItem().getCode();
            
            if (codePay.equals(codeDoc)) {
                moDecDocExchangeRate.setValue(0d);
                moDecDocExchangeRate.setEnabled(false);
                jbDocExchangeRatePick.setEnabled(false);
                jbDocExchangeRateInvert.setEnabled(false);
            }
            else {
                moDecDocExchangeRate.resetField();
                moDecDocExchangeRate.setEnabled(mnModePaymentDoc != 0);
                jbDocExchangeRatePick.setEnabled(/*mnModePaymentDoc != 0*/false); // should be enabled when needed, but until implemented!
                jbDocExchangeRateInvert.setEnabled(mnModePaymentDoc != 0);
            }
        }
        
        moCurDocBalancePrevDoc.setCompoundText(codeDoc);
        moCurDocPaymentDoc.setCompoundText(codeDoc);
        moCurDocBalancePendDoc.setCompoundText(codeDoc);
        
        computePaymentDocPend();
        
        if (moKeyPayCurrency.getSelectedIndex() <= 0 || moKeyDocCurrency.getSelectedIndex() <= 0) {
            jtfDocExchangeRate.setText("");
        }
        else {
            String codePay = moKeyPayCurrency.getSelectedItem().getCode();
            if (codePay.equals(codeDoc)) {
                jtfDocExchangeRate.setText("");
            }
            else {
                jtfDocExchangeRate.setText(codeDoc + "/" + codePay);
            }
        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup bgMode;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel12;
    private javax.swing.JPanel jPanel14;
    private javax.swing.JPanel jPanel16;
    private javax.swing.JPanel jPanel18;
    private javax.swing.JPanel jPanel19;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel24;
    private javax.swing.JPanel jPanel26;
    private javax.swing.JPanel jPanel27;
    private javax.swing.JPanel jPanel28;
    private javax.swing.JPanel jPanel29;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel48;
    private javax.swing.JPanel jPanel49;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel50;
    private javax.swing.JPanel jPanel51;
    private javax.swing.JPanel jPanel52;
    private javax.swing.JPanel jPanel53;
    private javax.swing.JPanel jPanel54;
    private javax.swing.JPanel jPanel55;
    private javax.swing.JPanel jPanel56;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JButton jbDfrCfdRelationsEdit;
    private javax.swing.JButton jbDocAdd;
    private javax.swing.JButton jbDocCancel;
    private javax.swing.JButton jbDocDelete;
    private javax.swing.JButton jbDocExchangeRateInvert;
    private javax.swing.JButton jbDocExchangeRatePick;
    private javax.swing.JButton jbDocModify;
    private javax.swing.JButton jbDocOk;
    private javax.swing.JButton jbDocPick;
    private javax.swing.JButton jbDummyExchangeRatePick;
    private javax.swing.JButton jbPayAdd;
    private javax.swing.JButton jbPayCancel;
    private javax.swing.JButton jbPayDelete;
    private javax.swing.JButton jbPayExchangeRatePick;
    private javax.swing.JButton jbPayModify;
    private javax.swing.JButton jbPayOk;
    private javax.swing.JButton jbReceiverEdit;
    private javax.swing.JButton jbReceiverPick;
    private javax.swing.JLabel jlCfdInfo;
    private javax.swing.JLabel jlCfdType;
    private javax.swing.JLabel jlDateDate;
    private javax.swing.JLabel jlDfrCfdRelations;
    private javax.swing.JLabel jlDfrConfirmation;
    private javax.swing.JLabel jlDfrIssuerTaxRegime;
    private javax.swing.JLabel jlDocBalancePend;
    private javax.swing.JLabel jlDocBalancePrev;
    private javax.swing.JLabel jlDocCurrency;
    private javax.swing.JLabel jlDocExchangeRate;
    private javax.swing.JLabel jlDocInstallment;
    private javax.swing.JLabel jlDocNumber;
    private javax.swing.JLabel jlDocPayment;
    private javax.swing.JLabel jlDummyCurrency;
    private javax.swing.JLabel jlDummyExchangeRate;
    private javax.swing.JLabel jlMode;
    private javax.swing.JLabel jlNumber;
    private javax.swing.JLabel jlPayAmountLoc;
    private javax.swing.JLabel jlPayAmountPay;
    private javax.swing.JLabel jlPayCurrency;
    private javax.swing.JLabel jlPayDatetime;
    private javax.swing.JLabel jlPayExchangeRate;
    private javax.swing.JLabel jlPayModeOfPaymentType;
    private javax.swing.JLabel jlPayOperation;
    private javax.swing.JLabel jlPayPayersAccount;
    private javax.swing.JLabel jlPayPayersBank;
    private javax.swing.JLabel jlPayPayersBankFiscalId;
    private javax.swing.JLabel jlPayRecipientsAccount;
    private javax.swing.JLabel jlPayRecipientsBankFiscalId;
    private javax.swing.JLabel jlTotalCfd;
    private javax.swing.JLabel jlTotalPayment;
    private javax.swing.JPanel jpBody;
    private javax.swing.JPanel jpContainer;
    private javax.swing.JPanel jpDfr1;
    private javax.swing.JPanel jpDfr11;
    private javax.swing.JPanel jpDfr12;
    private javax.swing.JPanel jpDfr13;
    private javax.swing.JPanel jpDfr2;
    private javax.swing.JPanel jpDfr21;
    private javax.swing.JPanel jpDfr22;
    private javax.swing.JPanel jpDfr23;
    private javax.swing.JPanel jpHeader;
    private javax.swing.JPanel jpHeaderMain;
    private javax.swing.JPanel jpHeaderMain1;
    private javax.swing.JPanel jpHeaderMain2;
    private javax.swing.JPanel jpPaymentDocs;
    private javax.swing.JPanel jpPaymentDocsControls;
    private javax.swing.JPanel jpPaymentDocsInput;
    private javax.swing.JPanel jpPayments;
    private javax.swing.JPanel jpPaymentsControls;
    private javax.swing.JPanel jpPaymentsInput;
    private javax.swing.JTextField jtfBranchCash;
    private javax.swing.JTextField jtfCfdStatus;
    private javax.swing.JTextField jtfCfdType;
    private javax.swing.JTextField jtfDfrCfdRelations;
    private javax.swing.JTextField jtfDfrCfdType;
    private javax.swing.JTextField jtfDfrDatetime;
    private javax.swing.JTextField jtfDfrPlaceOfIssue;
    private javax.swing.JTextField jtfDfrReceiverFiscalAddress;
    private javax.swing.JTextField jtfDfrReceiverFiscalId;
    private javax.swing.JTextField jtfDfrUuid;
    private javax.swing.JTextField jtfDfrVersion;
    private javax.swing.JTextField jtfDocExchangeRate;
    private javax.swing.JTextField jtfDocStatus;
    private javax.swing.JTextField jtfDocType;
    private javax.swing.JTextField jtfOwnBranch;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurDocBalancePendDoc;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurDocBalancePendPay;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurDocBalancePrevDoc;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurDocBalancePrevPay;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurDocPaymentDoc;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurDocPaymentPay;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurPayAmountLoc;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurPayAmountPay;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurTotalCfdLoc;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurTotalCfdPay;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurTotalPaymentLoc;
    private sba.lib.gui.bean.DBeanCompoundFieldCurrency moCurTotalPaymentPay;
    private sba.lib.gui.bean.DBeanFieldDate moDateDate;
    private sba.lib.gui.bean.DBeanFieldDate moDatePayDate;
    private sba.lib.gui.bean.DBeanFieldDecimal moDecDocExchangeRate;
    private sba.lib.gui.bean.DBeanFieldDecimal moDecDummyExchangeRate;
    private sba.lib.gui.bean.DBeanFieldDecimal moDecPayExchangeRate;
    private sba.lib.gui.bean.DBeanFieldInteger moIntDocInstallment;
    private sba.lib.gui.bean.DBeanFieldInteger moIntDocNumber;
    private sba.lib.gui.bean.DBeanFieldInteger moIntNumber;
    private sba.lib.gui.bean.DBeanFieldKey moKeyDfrCfdUsage;
    private sba.lib.gui.bean.DBeanFieldKey moKeyDfrIssuerTaxRegime;
    private sba.lib.gui.bean.DBeanFieldKey moKeyDfrReceiverTaxRegime;
    private sba.lib.gui.bean.DBeanFieldKey moKeyDocCurrency;
    private sba.lib.gui.bean.DBeanFieldKey moKeyDummyCurrency;
    private sba.lib.gui.bean.DBeanFieldKey moKeyPayCurrency;
    private sba.lib.gui.bean.DBeanFieldKey moKeyPayModeOfPaymentType;
    private sba.lib.gui.bean.DBeanFieldKey moKeyReceiver;
    private sba.lib.gui.bean.DBeanFieldRadio moRadModeEmit;
    private sba.lib.gui.bean.DBeanFieldRadio moRadModeEmitPay;
    private sba.lib.gui.bean.DBeanFieldText moTextDfrConfirmation;
    private sba.lib.gui.bean.DBeanFieldText moTextDocSeries;
    private sba.lib.gui.bean.DBeanFieldText moTextDocUuid;
    private sba.lib.gui.bean.DBeanFieldText moTextPayOperation;
    private sba.lib.gui.bean.DBeanFieldText moTextPayPayersAccount;
    private sba.lib.gui.bean.DBeanFieldText moTextPayPayersBank;
    private sba.lib.gui.bean.DBeanFieldText moTextPayPayersBankFiscalId;
    private sba.lib.gui.bean.DBeanFieldText moTextPayRecipientsAccount;
    private sba.lib.gui.bean.DBeanFieldText moTextPayRecipientsBankFiscalId;
    private sba.lib.gui.bean.DBeanFieldText moTextPayTime;
    private sba.lib.gui.bean.DBeanFieldText moTextSeries;
    // End of variables declaration//GEN-END:variables

    @Override
    public void addAllListeners() {
        jbReceiverPick.addActionListener(this);
        jbReceiverEdit.addActionListener(this);
        jbDummyExchangeRatePick.addActionListener(this);
        jbDfrCfdRelationsEdit.addActionListener(this);
        jbPayExchangeRatePick.addActionListener(this);
        jbPayAdd.addActionListener(this);
        jbPayModify.addActionListener(this);
        jbPayDelete.addActionListener(this);
        jbPayOk.addActionListener(this);
        jbPayCancel.addActionListener(this);
        jbDocPick.addActionListener(this);
        jbDocExchangeRatePick.addActionListener(this);
        jbDocExchangeRateInvert.addActionListener(this);
        jbDocAdd.addActionListener(this);
        jbDocModify.addActionListener(this);
        jbDocDelete.addActionListener(this);
        jbDocOk.addActionListener(this);
        jbDocCancel.addActionListener(this);
        mjButtonLaunchCalc.addActionListener(this);
        
        moDecPayExchangeRate.addFocusListener(this);
        moCurPayAmountPay.getField().getComponent().addFocusListener(this);
        moTextDocUuid.addFocusListener(this);
        moDecDocExchangeRate.addFocusListener(this);
        moCurDocBalancePrevDoc.getField().getComponent().addFocusListener(this);
        moCurDocPaymentDoc.getField().getComponent().addFocusListener(this);
        
        moKeyReceiver.addItemListener(this);
        moKeyPayCurrency.addItemListener(this);
        moKeyDocCurrency.addItemListener(this);
    }

    @Override
    public void removeAllListeners() {
        jbReceiverPick.removeActionListener(this);
        jbReceiverEdit.removeActionListener(this);
        jbDummyExchangeRatePick.removeActionListener(this);
        jbDfrCfdRelationsEdit.removeActionListener(this);
        jbPayExchangeRatePick.removeActionListener(this);
        jbPayAdd.removeActionListener(this);
        jbPayModify.removeActionListener(this);
        jbPayDelete.removeActionListener(this);
        jbPayOk.removeActionListener(this);
        jbPayCancel.removeActionListener(this);
        jbDocPick.removeActionListener(this);
        jbDocExchangeRatePick.removeActionListener(this);
        jbDocExchangeRateInvert.removeActionListener(this);
        jbDocAdd.removeActionListener(this);
        jbDocModify.removeActionListener(this);
        jbDocDelete.removeActionListener(this);
        jbDocOk.removeActionListener(this);
        jbDocCancel.removeActionListener(this);
        mjButtonLaunchCalc.removeActionListener(this);
        
        moDecPayExchangeRate.removeFocusListener(this);
        moCurPayAmountPay.getField().getComponent().removeFocusListener(this);
        moTextDocUuid.addFocusListener(this);
        moDecDocExchangeRate.removeFocusListener(this);
        moCurDocBalancePrevDoc.getField().getComponent().removeFocusListener(this);
        moCurDocPaymentDoc.getField().getComponent().removeFocusListener(this);
        
        moKeyReceiver.removeItemListener(this);
        moKeyPayCurrency.removeItemListener(this);
        moKeyDocCurrency.removeItemListener(this);
    }

    @Override
    public void reloadCatalogues() {
        miClient.getSession().populateCatalogue(moKeyReceiver, DModConsts.BU_BPR, DModSysConsts.BS_BPR_CL_CUS, null);
        miClient.getSession().populateCatalogue(moKeyDfrIssuerTaxRegime, DModConsts.CS_TAX_REG, mnCompanyIdentityType, null);
    }

    @Override
    public void setRegistry(DDbRegistry registry) throws Exception {
        moRegistry = (DDbDfr) registry;

        mnFormResult = 0;
        mbFirstActivation = true;

        moConfigCompany = (DDbConfigCompany) miClient.getSession().getConfigCompany();
        
        // Set registry:

        removeAllListeners();
        reloadCatalogues();

        jbSave.setEnabled(false);
        
        if (moRegistry.isRegistryNew()) {
            moRegistry.initPrimaryKey();
            
            // company branch & cash:
            
            moConfigBranch = (DDbConfigBranch) miClient.getSession().getConfigBranch();

            DGuiClientSessionCustom sessionCustom = (DGuiClientSessionCustom) miClient.getSession().getSessionCustom();
            if (sessionCustom.getBranchKey() == null) {
                mbCanShowForm = false;
                msCanShowFormMessage = DUtilConsts.ERR_MSG_USR_SES_BRA;
                return;
            }
            else if (sessionCustom.getBranchCashKey() == null) {
                mbCanShowForm = false;
                msCanShowFormMessage = DUtilConsts.ERR_MSG_USR_SES_BRA_CSH;
                return;
            }
            else {
                moBranchCash = (DDbBranchCash) miClient.getSession().readRegistry(DModConsts.CU_CSH, sessionCustom.getBranchCashKey());
            }
            
            moRegistry.setFkOwnerBizPartnerId(moConfigBranch.getCompanyId());
            moRegistry.setFkOwnerBranchId(moConfigBranch.getBranchId());
            moRegistry.setFkCashBizPartnerId_n(moBranchCash.getPkBizPartnerId());
            moRegistry.setFkCashBranchId_n(moBranchCash.getPkBranchId());
            moRegistry.setFkCashCashId_n(moBranchCash.getPkCashId());
            
            // finish setting up registry:
            
            moRegistry.setFkXmlTypeId(DModSysConsts.TS_XML_TP_CFDI_40);
            moRegistry.setFkXmlSubtypeId(DModSysConsts.TS_XML_STP_CFDI_CRP);
            
            DDfr dfr = new DDfr();
            dfr.setPlaceOfIssue(moConfigCompany.getChildBizPartner().getChildBranchHeadquarters().getChildAddressOfficial().getZipCode());
            dfr.setIssuerTaxRegime("" + moConfigCompany.getChildBizPartner().getFkTaxRegimeId()); // id = code
            moRegistry.setXtaDfr(dfr);
            
            moTextSeries.setValue(moConfigBranch.getDfrCrpSeries());
            moIntNumber.setValue(0);
            moRadModeEmitPay.setSelected(true);
            
            mtOriginalDate = miClient.getSession().getWorkingDate();
            
            moRegistryLock = null;
            jtfRegistryKey.setText("");
        }
        else {
            // company branch & cash:
            
            moConfigBranch = (DDbConfigBranch) miClient.getSession().readRegistry(DModConsts.CU_CFG_BRA, moRegistry.getCompanyBranchKey());
            
            moBranchCash = (DDbBranchCash) miClient.getSession().readRegistry(DModConsts.CU_CSH, moRegistry.getBranchCashKey_n());

            // finish setting up registry:
            
            moTextSeries.setValue(moRegistry.getSeries());
            moIntNumber.setValue(moRegistry.getNumber());
            moRadModeEmitPay.setSelected(moRegistry.isBookeept());

            mtOriginalDate = moRegistry.getDocTs();
            
            moRegistryLock = moRegistry.assureLock(miClient.getSession());
            jtfRegistryKey.setText(DLibUtils.textKey(moRegistry.getPrimaryKey()));
        }
        
        setFormEditable(true);  // enable all controls before setting form values
        
        moKeyReceiver.setValue(new int[] { moRegistry.getFkBizPartnerId() });
        itemStateChangedCfdReceiver();
        if (!moRegistry.isRegistryNew() && moRegistry.getXtaDfr() != null) {
            jtfDfrReceiverFiscalAddress.setText(moRegistry.getXtaDfr().getReceiverFiscalAddress());
            jtfDfrReceiverFiscalAddress.setCaretPosition(0);
        }
        
        moKeyDfrReceiverTaxRegime.setValue(new int[] { DLibUtils.parseInt(moRegistry.getXtaDfr().getReceiverTaxRegime()) });
        moKeyDfrCfdUsage.setValue(new int[] { moXmlCatalogCfdUsage.getId(moRegistry.getXtaDfr().getCfdUsage()) });

        mnOriginalYear = DLibTimeUtils.digestYear(mtOriginalDate)[0];
        moDateDate.setValue(mtOriginalDate);
        
        moKeyDummyCurrency.setValue(new int[] { moXmlCatalogCurrency.getId(DCfdi40Catalogs.ClaveMonedaXxx) });
        moDecDummyExchangeRate.setValue(1.0);
        
        jtfDfrPlaceOfIssue.setText(moRegistry.getXtaDfr().getPlaceOfIssue());
        jtfDfrPlaceOfIssue.setCaretPosition(0);
        moTextDfrConfirmation.setValue(moRegistry.getXtaDfr().getConfirmation());
        moKeyDfrIssuerTaxRegime.setValue(new int[] { DLibUtils.parseInt(moRegistry.getXtaDfr().getIssuerTaxRegime()) }); // id = code
        jtfDfrCfdRelations.setText(moRegistry.getXtaDfr().getCfdRelations() == null ? "" : moRegistry.getXtaDfr().getCfdRelations().toString());
        jtfDfrCfdRelations.setCaretPosition(0);
        
        jtfDocType.setText((String) miClient.getSession().readField(DModConsts.TS_XML_STP, new int[] { moRegistry.getFkXmlSubtypeId() }, DDbRegistry.FIELD_NAME));
        jtfDocType.setCaretPosition(0);
        
        jtfDocStatus.setText((String) miClient.getSession().readField(DModConsts.TS_XML_ST, new int[] { moRegistry.getFkXmlStatusId() }, DDbRegistry.FIELD_NAME));
        jtfDocStatus.setCaretPosition(0);
        
        jtfDfrCfdType.setText(moRegistry.getXtaDfr().getCfdType());
        jtfDfrCfdType.setCaretPosition(0);
        
        jtfDfrVersion.setText(moRegistry.getXtaDfr().getVersion());
        jtfDfrVersion.setCaretPosition(0);
        
        jtfDfrDatetime.setText(DLibUtils.DateFormatDatetime.format(moRegistry.getDocTs()));
        jtfDfrDatetime.setCaretPosition(0);
        
        jtfDfrUuid.setText(moRegistry.getUuid());
        jtfDfrUuid.setCaretPosition(0);
        
        jtfCfdType.setText((String) miClient.getSession().readField(DModConsts.TS_XML_TP, new int[] { moRegistry.getFkXmlTypeId() }, DDbRegistry.FIELD_NAME));
        jtfCfdType.setCaretPosition(0);
        
        jtfCfdStatus.setText((String) miClient.getSession().readField(DModConsts.TS_XML_ST, new int[] { moRegistry.getFkXmlStatusId() }, DDbRegistry.FIELD_NAME));
        jtfCfdStatus.setCaretPosition(0);
        
        jtfOwnBranch.setText((String) miClient.getSession().readField(DModConsts.BU_BRA, moConfigBranch.getPrimaryKey(), DDbRegistry.FIELD_CODE));
        jtfOwnBranch.setCaretPosition(0);
        
        jtfBranchCash.setText((String) miClient.getSession().readField(DModConsts.CU_CSH, moBranchCash.getPrimaryKey(), DDbRegistry.FIELD_CODE));
        jtfBranchCash.setCaretPosition(0);
        
        DElementComprobante comprobante33 = moRegistry.getElementComprobante33();
        Vector<DGridRow> payments = new Vector<>();
        
        if (comprobante33 != null && comprobante33.getEltOpcComplemento() != null) {
            for (DElement element : comprobante33.getEltOpcComplemento().getElements()) {
                if (element instanceof DElementPagos) {
                    DElementPagos pagos = (DElementPagos) element;
                    for (DElementPagosPago pago : pagos.getEltPagos()) {
                        payments.add(new DRowDfrPayment(pago));
                    }
                    break;
                }
            }
        }
        
        moGridPayments.populateGrid(payments, this);
        if (payments.isEmpty()) {
            renderPayment(null);
        }
        else {
            activateInputPayment(0);
        }
        
        enabledFieldsDfr();
        itemStateChangedPayCurrency();
        itemStateChangedDocCurrency();
        
        computeTotalCfd();
        computeTotalPayment();
        
        moDialogFindBizPartner.initForm();
        
        if (moRegistry.isRegistryNew()) {
            jbSave.setEnabled(true);
        }
        else {
            jbSave.setEnabled(!moRegistry.isSystem() && !DLibUtils.belongsTo(moRegistry.getFkXmlStatusId(), new int[] { DModSysConsts.TS_XML_ST_ISS, DModSysConsts.TS_XML_ST_ANN }));
        }

        addAllListeners();
    }

    @Override
    public DDbDfr getRegistry() throws Exception {
        DDbDfr registry = moRegistry.clone();
        
        //registry.setPkDfrId();
        
        if (registry.isRegistryNew()) {
            registry.setSeries(moTextSeries.getValue());
        }
        else {
            registry.setAuxLock(moRegistryLock);
        }

        /* will be set in method DDbDfr.prepareDfr()
        registry.setNumber();
        registry.setCertificateNumber();
        registry.setSignedText();
        registry.setSignature();
        registry.setUuid();
        */
        registry.setDocTs(moDateDate.getValue());
        /*
        registry.setDocXml();
        registry.setDocXmlRaw();
        registry.setDocXmlAddenda();
        registry.setDocXmlName();
        registry.setCancelStatus();
        registry.setCancelXml();
        registry.setCancelPdf_n();
        */
        registry.setBookeept(moRadModeEmitPay.isSelected());
        /*
        registry.setDeleted();
        registry.setSystem();
        registry.setFkXmlTypeId();
        registry.setFkXmlSubtypeId();
        registry.setFkXmlStatusId();
        registry.setFkXmlAddendaTypeId();
        registry.setFkXmlSignatureProviderId();
        registry.setFkCertificateId();
        registry.setFkOwnerBizPartnerId();
        registry.setFkOwnerBranchId();
        */
        registry.setFkBizPartnerId(moBizPartner.getPkBizPartnerId());
        /*
        registry.setFkDpsId_n();
        registry.setFkCashBizPartnerId_n();
        registry.setFkCashBranchId_n();
        registry.setFkCashCashId_n();
        registry.setFkBookkeepingYearId_n();
        registry.setFkBookkeepingNumberId_n();
        registry.setFkUserIssuedId();
        registry.setFkUserAnnulledId();
        registry.setFkUserInsertId();
        registry.setFkUserUpdateId();
        registry.setTsUserIssued();
        registry.setTsUserAnnulled();
        registry.setTsUserInsert();
        registry.setTsUserUpdate();
        */
        
        /*
        registry.setAuxJustIssued();
        registry.setAuxJustAnnulled();
        */
        registry.setAuxComputeBookkeeping(true);
        /*
        registry.setAuxRewriteXmlOnSave();
        registry.setAuxRegenerateXmlOnSave();
        registry.setAuxXmlSignatureRequestKey();
        */

        float version = 0;

        switch (registry.getFkXmlTypeId()) {
            case DModSysConsts.TS_XML_TP_CFDI_33:
                version = DCfdConsts.CFDI_VER_33;
                break;
            case DModSysConsts.TS_XML_TP_CFDI_40:
                version = DCfdConsts.CFDI_VER_40;
                break;
            default:
                throw new Exception(DLibConsts.ERR_MSG_OPTION_UNKNOWN + "\nTipo XML.");
        }
        
        DDfr dfr = new DDfr();
        
        dfr.setCfdType(DCfdi40Catalogs.CFD_TP_P);
        dfr.setVersion("" + version);
        dfr.setPlaceOfIssue(jtfDfrPlaceOfIssue.getText());
        //dfr.setMethodOfPayment(...);
        //dfr.setPaymentTerms(...);
        dfr.setConfirmation(moTextDfrConfirmation.getValue());
        dfr.setIssuerTaxRegime(moKeyDfrIssuerTaxRegime.getSelectedIndex() <= 0 ? "" : "" + moKeyDfrIssuerTaxRegime.getValue()[0]); // id = code
        dfr.setReceiverTaxRegime(moKeyDfrReceiverTaxRegime.getSelectedIndex() <= 0 ? "" : "" + moKeyDfrReceiverTaxRegime.getValue()[0]); // id = code
        dfr.setReceiverFiscalAddress(moBizPartnerBranchAddressOfficial.getZipCode());
        dfr.setCfdUsage(moKeyDfrCfdUsage.getSelectedIndex() <= 0 ? "" : moKeyDfrCfdUsage.getSelectedItem().getCode());
        //dfr.setGlobalPeriodicity(...);
        //dfr.setGlobalMonths(...);
        //dfr.setGlobalYear(...);
        dfr.setCfdRelations(moRegistry.getXtaDfr().getCfdRelations()); // current relations already in registry
        
        // add DFR complement:
        
        DElementPagos pagos = new DElementPagos();
        for (DGridRow row : moGridPayments.getModel().getGridRows()) {
            pagos.getEltPagos().add(((DRowDfrPayment) row).getPago());
        }
        
        registry.setDfrPagos(pagos);
                
        return registry;
    }

    @Override
    public DGuiValidation validateForm() {
        DGuiValidation validation = moFields.validateFields();

        if (validation.isValid()) {
            if (DLibTimeUtils.digestYear(moDateDate.getValue())[0] != mnOriginalYear) {
                validation.setMessage(DGuiConsts.ERR_MSG_FIELD_DATE_ + "'" + DGuiUtils.getLabelName(jlDateDate.getText()) + "'" +
                        DGuiConsts.ERR_MSG_FIELD_DATE_YEAR + DLibUtils.DecimalFormatCalendarYear.format(mnOriginalYear) + ".");
                validation.setComponent(moDateDate);
            }
            else if (moGridPayments.getTable().getRowCount() == 0) {
                validation.setMessage(DUtilConsts.ERR_MSG_DOC_NO_ROWS);
                validation.setComponent(jbPayAdd);
            }
            else {
                // validate payments vs. payments applied to documents:
                for (DGridRow row : moGridPayments.getModel().getGridRows()) {
                    DElementPagosPago pago = ((DRowDfrPayment) row).getPago();
                    double payment = DLibUtils.roundAmount(pago.getAttMonto().getDouble());
                    double paymentDocs = 0;
                    
                    for (DElementDoctoRelacionado doctoRelacionado : pago.getEltDoctoRelacionados()) {
                        double xrt = doctoRelacionado.getAttTipoCambioDR().getDouble();
                        double paymentDoc = doctoRelacionado.getAttImpPagado().getDouble();
                        paymentDocs = DLibUtils.roundAmount(paymentDocs + (xrt == 0 ? paymentDoc : DLibUtils.roundAmount(paymentDoc / xrt)));
                    }
                    
                    if ((paymentDocs - payment) > 0d) {
                        moGridPayments.setSelectedGridRow(moGridPayments.getModel().getGridRows().indexOf(row));
                        
                        validation.setMessage("La suma de pagos aplicados $ " + DLibUtils.getDecimalFormatAmount().format(paymentDocs) + " " + pago.getAttMonedaP().getString() + " "
                                + "es mayor al monto del pago $ " + DLibUtils.getDecimalFormatAmount().format(payment) + " " + pago.getAttMonedaP().getString() + ".");
                        break;
                    }
                    else if ((paymentDocs - payment) < 0d) {
                        moGridPayments.setSelectedGridRow(moGridPayments.getModel().getGridRows().indexOf(row));
                        
                        if (miClient.showMsgBoxConfirm("La suma de pagos aplicados $ " + DLibUtils.getDecimalFormatAmount().format(paymentDocs) + " " + pago.getAttMonedaP().getString() + " "
                                + "es menor al monto del pago $ " + DLibUtils.getDecimalFormatAmount().format(payment) + " " + pago.getAttMonedaP().getString() + ".\n"
                                + DGuiConsts.MSG_CNF_CONT) != JOptionPane.YES_OPTION) {
                            validation.setMessage("Corregir el monto de los pagos aplicados.");
                            break;
                        }
                    }
                }
            }
        }
        
        if (validation.isValid()) {
            if (moRadModeEmit.isSelected() && miClient.showMsgBoxConfirm("¿Sólo emitir CFDI sin aplicar pagos?") != JOptionPane.YES_OPTION) {
                validation.setMessage("Indicar que se desea emitir CFDI y aplicar pagos.");
                validation.setComponent(moRadModeEmitPay);
            }
        }

        return validation;
    }

    @Override
    public void setValue(final int type, final Object value) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public Object getValue(final int type) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void actionCancel() {
        boolean cancel = true;

        if (mnFormStatus == DGuiConsts.FORM_STATUS_EDIT && jbSave.isEnabled()) {
            cancel = miClient.showMsgBoxConfirm(DGuiConsts.MSG_CNF_FORM_CLS) == JOptionPane.YES_OPTION;
        }

        if (cancel) {
            freeLockByCancel();
            super.actionCancel();
        }
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();

            if (button == jbReceiverPick) {
                actionPerformedReceiverPick();
            }
            else if (button == jbReceiverEdit) {
                actionPerformedReceiverEdit();
            }
            else if (button == jbDummyExchangeRatePick) {
                actionPerformedDfrExchangeRatePick();
            }
            else if (button == jbDfrCfdRelationsEdit) {
                actionPerformedDfrCfdRelationsEdit();
            }
            else if (button == jbPayExchangeRatePick) {
                actionPerformedPayExchangeRatePick();
            }
            else if (button == jbPayAdd) {
                actionPerformedPayAdd();
            }
            else if (button == jbPayModify) {
                actionPerformedPayModify();
            }
            else if (button == jbPayDelete) {
                actionPerformedPayDelete();
            }
            else if (button == jbPayOk) {
                actionPerformedPayOk();
            }
            else if (button == jbPayCancel) {
                actionPerformedPayCancel();
            }
            else if (button == jbDocPick) {
                actionPerformedDocPick();
            }
            else if (button == jbDocExchangeRatePick) {
                actionPerformedDocExchangeRatePick();
            }
            else if (button == jbDocExchangeRateInvert) {
                actionPerformedDocExchangeRateInvert();
            }
            else if (button == jbDocAdd) {
                actionPerformedDocAdd();
            }
            else if (button == jbDocModify) {
                actionPerformedDocModify();
            }
            else if (button == jbDocDelete) {
                actionPerformedDocDelete();
            }
            else if (button == jbDocOk) {
                actionPerformedDocOk();
            }
            else if (button == jbDocCancel) {
                actionPerformedDocCancel();
            }
            else if (button == mjButtonLaunchCalc) {
                actionPerformedLaunchCalc();
            }
        }
    }

    @Override
    public void focusGained(FocusEvent e) {

    }

    @Override
    public void focusLost(FocusEvent e) {
        if (e.getSource() instanceof DBeanFieldText) {
            DBeanFieldText field = (DBeanFieldText) e.getSource();

            if (field == moTextDocUuid) {
                focusLostDocUuid();
            }
        }
        else if (e.getSource() instanceof DBeanFieldDecimal) {
            DBeanFieldDecimal field = (DBeanFieldDecimal) e.getSource();

            if (field == moDecPayExchangeRate) {
                computePayment();
            }
            else if (field == moCurPayAmountPay.getField()) {
                computePayment();
            }
            else if (field == moDecDocExchangeRate) {
                computePaymentDoc();
            }
            else if (field == moCurDocBalancePrevDoc.getField()) {
                computePaymentDocPend();
            }
            else if (field == moCurDocPaymentDoc.getField()) {
                computePaymentDocPend();
            }
        }
    }

    @Override
    public void itemStateChanged(ItemEvent e) {
        if (e.getSource() instanceof DBeanFieldKey) {
            if (e.getStateChange() == ItemEvent.SELECTED) {
                DBeanFieldKey field = (DBeanFieldKey) e.getSource();

                if (field == moKeyReceiver) {
                    itemStateChangedCfdReceiver();
                }
                else if (field == moKeyPayCurrency) {
                    itemStateChangedPayCurrency();
                }
                else if (field == moKeyDocCurrency) {
                    itemStateChangedDocCurrency();
                }
            }
        }
    }

    @Override
    public void valueChanged(ListSelectionEvent e) {
        if (e.getSource() instanceof ListSelectionModel) {
            ListSelectionModel model = (ListSelectionModel) e.getSource();
            
            if (model == moGridPayments.getTable().getSelectionModel()) {
                renderPayment(moGridPayments.getSelectedGridRow());
            }
            else if (model == moGridPaymentDocs.getTable().getSelectionModel()) {
                renderPaymentDoc(moGridPaymentDocs.getSelectedGridRow());
            }
        }
    }
}
