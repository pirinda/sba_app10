/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package sba.mod.cfg.form;

import java.awt.event.KeyEvent;
import java.awt.event.MouseEvent;
import java.util.Vector;
import javax.swing.border.TitledBorder;
import sba.gui.util.DUtilConsts;
import sba.lib.DLibConsts;
import sba.lib.db.DDbRegistry;
import sba.lib.gui.DGuiClient;
import sba.lib.gui.DGuiConsts;
import sba.lib.gui.DGuiItem;
import sba.mod.DModConsts;
import sba.mod.bpr.db.DDbBranch;
import sba.mod.cfg.db.DDbBranchCash;
import sba.mod.cfg.db.DDbBranchWarehouse;
import sba.mod.cfg.db.DDbUser;

/**
 *
 * @author Sergio Flores
 */
public class DPickerBranchEntity extends javax.swing.JDialog {

    private int mnType;
    private int mnResult;
    private boolean mbFirstActivation;
    private DGuiClient miClient;

    /**
     * Creates new form DPickerBranchEntity
     * @param client GUI client.
     * @param type Constants defined in DModConsts (CU_CSH or CU_WAH).
     */
    public DPickerBranchEntity(DGuiClient client, int type) {
        super(client.getFrame(), true);
        miClient = client;
        mnType = type;
        initComponents();
        initComponentsCustom();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jpEntities = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jPanel11 = new javax.swing.JPanel();
        jlCompany = new javax.swing.JLabel();
        jtfCompany = new javax.swing.JTextField();
        jPanel3 = new javax.swing.JPanel();
        jlBranch = new javax.swing.JLabel();
        jcbBranch = new javax.swing.JComboBox();
        jPanel5 = new javax.swing.JPanel();
        jlBranchEntity = new javax.swing.JLabel();
        jspBranchEntity = new javax.swing.JScrollPane();
        jltBranchEntity = new javax.swing.JList();
        jpControls = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setModal(true);
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jpEntities.setBorder(javax.swing.BorderFactory.createTitledBorder("Entidades disponibles:"));
        jpEntities.setLayout(new java.awt.BorderLayout());

        jPanel4.setLayout(new java.awt.GridLayout(3, 1, 0, 5));

        jPanel11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlCompany.setText("Empresa:");
        jlCompany.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel11.add(jlCompany);

        jtfCompany.setEditable(false);
        jtfCompany.setToolTipText("Nombre");
        jtfCompany.setFocusable(false);
        jtfCompany.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel11.add(jtfCompany);

        jPanel4.add(jPanel11);

        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlBranch.setText("Sucursal:");
        jlBranch.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel3.add(jlBranch);

        jcbBranch.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        jcbBranch.setPreferredSize(new java.awt.Dimension(200, 23));
        jcbBranch.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                jcbBranchItemStateChanged(evt);
            }
        });
        jcbBranch.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jcbBranchKeyPressed(evt);
            }
        });
        jPanel3.add(jcbBranch);

        jPanel4.add(jPanel3);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlBranchEntity.setText("Seleccionar una opci√≥n:");
        jlBranchEntity.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel5.add(jlBranchEntity);

        jPanel4.add(jPanel5);

        jpEntities.add(jPanel4, java.awt.BorderLayout.NORTH);

        jltBranchEntity.setModel(new javax.swing.AbstractListModel() {
            String[] strings = { "Item 1", "Item 2", "Item 3", "Item 4", "Item 5" };
            public int getSize() { return strings.length; }
            public Object getElementAt(int i) { return strings[i]; }
        });
        jltBranchEntity.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jltBranchEntityMouseClicked(evt);
            }
        });
        jltBranchEntity.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jltBranchEntityKeyPressed(evt);
            }
        });
        jspBranchEntity.setViewportView(jltBranchEntity);

        jpEntities.add(jspBranchEntity, java.awt.BorderLayout.CENTER);

        getContentPane().add(jpEntities, java.awt.BorderLayout.CENTER);

        jpControls.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jbOk.setText("Aceptar");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jbOk.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbOkActionPerformed(evt);
            }
        });
        jpControls.add(jbOk);

        jbCancel.setText("Cancelar");
        jbCancel.setPreferredSize(new java.awt.Dimension(75, 23));
        jbCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbCancelActionPerformed(evt);
            }
        });
        jpControls.add(jbCancel);

        getContentPane().add(jpControls, java.awt.BorderLayout.PAGE_END);

        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setBounds((screenSize.width-416)/2, (screenSize.height-288)/2, 416, 288);
    }// </editor-fold>//GEN-END:initComponents

    private void jbOkActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbOkActionPerformed
        actionOk();
    }//GEN-LAST:event_jbOkActionPerformed

    private void jbCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbCancelActionPerformed
        actionCancel();
    }//GEN-LAST:event_jbCancelActionPerformed

    private void jcbBranchKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jcbBranchKeyPressed
        keyPressedBranch(evt);
    }//GEN-LAST:event_jcbBranchKeyPressed

    private void jltBranchEntityKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jltBranchEntityKeyPressed
        keyPressedBranchEntity(evt);
    }//GEN-LAST:event_jltBranchEntityKeyPressed

    private void jcbBranchItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_jcbBranchItemStateChanged
        itemStateBranch();
    }//GEN-LAST:event_jcbBranchItemStateChanged

    private void jltBranchEntityMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jltBranchEntityMouseClicked
        mouseClickedBranch(evt);
    }//GEN-LAST:event_jltBranchEntityMouseClicked

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivated();
    }//GEN-LAST:event_formWindowActivated

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbOk;
    private javax.swing.JComboBox jcbBranch;
    private javax.swing.JLabel jlBranch;
    private javax.swing.JLabel jlBranchEntity;
    private javax.swing.JLabel jlCompany;
    private javax.swing.JList jltBranchEntity;
    private javax.swing.JPanel jpControls;
    private javax.swing.JPanel jpEntities;
    private javax.swing.JScrollPane jspBranchEntity;
    private javax.swing.JTextField jtfCompany;
    // End of variables declaration//GEN-END:variables

    /*
     * Private methods
     */

    private void initComponentsCustom() {
        DDbUser user = (DDbUser) miClient.getSession().getUser();

        switch (mnType) {
            case DModConsts.CU_CSH:
                setTitle(DUtilConsts.TXT_SELECT + " " + DUtilConsts.TXT_BRANCH_CSH.toLowerCase());
                ((TitledBorder) jpEntities.getBorder()).setTitle(DUtilConsts.TXT_BRANCH_CSH_PLR);
                break;
            case DModConsts.CU_WAH:
                setTitle(DUtilConsts.TXT_SELECT + " " + DUtilConsts.TXT_BRANCH_WAH.toLowerCase());
                ((TitledBorder) jpEntities.getBorder()).setTitle(DUtilConsts.TXT_BRANCH_WAH_PLR);
                break;
            default:
                miClient.showMsgBoxError(DLibConsts.ERR_MSG_OPTION_UNKNOWN);
        }

        jtfCompany.setText((String) miClient.getSession().readField(DModConsts.BU_BPR, new int[] { DUtilConsts.BPR_CO_ID }, DDbRegistry.FIELD_NAME));
        jtfCompany.setCaretPosition(0);

        jcbBranch.removeAllItems();
        jcbBranch.addItem(new DGuiItem("- " + DUtilConsts.TXT_BRANCH + " -"));

        for (DDbBranch branch : user.getAuxBranches()) {
            jcbBranch.addItem(new DGuiItem(branch.getPrimaryKey(), branch.getName()));
        }

        jcbBranch.setSelectedIndex(0);
    }

    private void windowActivated() {
        if (mbFirstActivation) {
            mbFirstActivation = false;
            jcbBranch.requestFocus();
        }
    }

    private void itemStateBranch() {
        int[] branchKey = null;
        Vector<DGuiItem> items = new Vector<>();
        DDbUser user = (DDbUser) miClient.getSession().getUser();

        if (jcbBranch.getSelectedIndex() <= 0) {
            jltBranchEntity.setEnabled(false);
            jltBranchEntity.setListData(items);
        }
        else {
            branchKey = ((DGuiItem) jcbBranch.getSelectedItem()).getPrimaryKey();

            switch (mnType) {
                case DModConsts.CU_CSH:
                    for (DDbBranchCash entity : user.getAuxBranchCashes(branchKey)) {
                        items.add(new DGuiItem(entity.getPrimaryKey(), entity.getName()));
                    }
                    break;
                case DModConsts.CU_WAH:
                    for (DDbBranchWarehouse entity : user.getAuxBranchWarehouses(branchKey)) {
                        items.add(new DGuiItem(entity.getPrimaryKey(), entity.getName()));
                    }
                    break;
                default:
            }

            jltBranchEntity.setEnabled(true);
            jltBranchEntity.setListData(items);

            if (jltBranchEntity.getModel().getSize() > 0) {
                jltBranchEntity.setSelectedIndex(0);
            }
        }
    }

    private void keyPressedBranch(KeyEvent evt) {
        if (evt.getKeyCode() == KeyEvent.VK_ENTER) {
            jltBranchEntity.requestFocus();
        }
    }

    private void keyPressedBranchEntity(KeyEvent evt) {
        if (evt.getKeyCode() == KeyEvent.VK_ENTER) {
            jbOk.requestFocus();
        }
    }

    private void mouseClickedBranch(MouseEvent evt) {
        if (evt.getClickCount() == 2) {
            actionOk();
        }
    }

    private void actionOk() {
        if (jltBranchEntity.getSelectedIndex() == -1) {
            miClient.showMsgBoxWarning(DGuiConsts.ERR_MSG_UNDEF_OPTION);
            jltBranchEntity.requestFocus();
        }
        else {
            mnResult = DGuiConsts.FORM_RESULT_OK;
            dispose();
        }
    }

    private void actionCancel() {
        mnResult = DGuiConsts.FORM_RESULT_CANCEL;
        dispose();
    }

    /*
     * Public methods
     */

    public void resetPicker() {
        mnResult = DLibConsts.UNDEFINED;
        mbFirstActivation = true;
    }

    public int getResult() {
        return mnResult;
    }

    public int[] getBranchEntity() {
        return jltBranchEntity.getSelectedIndex() == -1 ? null : ((DGuiItem) jltBranchEntity.getSelectedValue()).getPrimaryKey();
    }
}
